#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Sync Publish Branch
POSCO ì‹œìŠ¤í…œ êµ¬ì„±ìš”ì†Œ

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import os
import subprocess
import shutil
from pathlib import Path

def sync_publish_branch():
    """publish ë¸Œëœì¹˜ë¥¼ main ë¸Œëœì¹˜ì˜ docs/ ë‚´ìš©ìœ¼ë¡œ ì™„ì „ ë™ê¸°í™”"""
    
    print("ğŸš€ publish ë¸Œëœì¹˜ ë™ê¸°í™” ì‹œì‘...")
    
    try:
        # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
        current_branch = subprocess.check_output(['git', 'branch', '--show-current'], text=True).strip()
        print(f"ğŸ”„ í˜„ì¬ ë¸Œëœì¹˜: {current_branch}")
        
        # main ë¸Œëœì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
        if current_branch != 'main':
            print("âŒ main ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
            return False
        
        # docs ë””ë ‰í† ë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸
        if not os.path.exists('docs'):
            print("âŒ docs ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return False
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ì— docs ë‚´ìš© ë³µì‚¬
        temp_dir = '/tmp/docs_backup'
        if os.path.exists(temp_dir):
            shutil.rmtree(temp_dir)
        
        print("ğŸ“‹ docs ë””ë ‰í† ë¦¬ ë°±ì—… ì¤‘...")
        shutil.copytree('docs', temp_dir)
        
        # publish ë¸Œëœì¹˜ë¡œ ì „í™˜
        print("ğŸ”„ publish ë¸Œëœì¹˜ë¡œ ì „í™˜...")
        subprocess.run(['git', 'checkout', 'publish'], check=True)
        
        # publish ë¸Œëœì¹˜ì˜ ê¸°ì¡´ ë‚´ìš© ì œê±° (git ë””ë ‰í† ë¦¬ ì œì™¸)
        print("ğŸ§¹ ê¸°ì¡´ ë‚´ìš© ì œê±° ì¤‘...")
        for item in os.listdir('.'):
            if item != '.git':
                if os.path.isdir(item):
                    shutil.rmtree(item)
                else:
                    os.remove(item)
        
        # docs ë‚´ìš©ì„ ë£¨íŠ¸ë¡œ ë³µì‚¬
        print("ğŸ“ ìƒˆë¡œìš´ ë‚´ìš© ë³µì‚¬ ì¤‘...")
        for item in os.listdir(temp_dir):
            src = os.path.join(temp_dir, item)
            dst = item
            
            if os.path.isdir(src):
                shutil.copytree(src, dst)
            else:
                shutil.copy2(src, dst)
        
        # ìµœì‹  í†µí•© ë¦¬í¬íŠ¸ë“¤ë„ ë³µì‚¬
        print("ğŸ“Š ìµœì‹  í†µí•© ë¦¬í¬íŠ¸ ë³µì‚¬ ì¤‘...")
        os.makedirs('reports', exist_ok=True)
        
        # main ë¸Œëœì¹˜ì˜ docs/reportsì—ì„œ í†µí•© ë¦¬í¬íŠ¸ ì°¾ê¸°
        main_reports_path = os.path.join(temp_dir, 'reports')
        if os.path.exists(main_reports_path):
            for file in os.listdir(main_reports_path):
                if file.startswith('posco_integrated_analysis_'):
                    src = os.path.join(main_reports_path, file)
                    dst = os.path.join('reports', file)
                    shutil.copy2(src, dst)
                    print(f"  âœ… {file}")
        
        # Gitì— ëª¨ë“  ë³€ê²½ì‚¬í•­ ì¶”ê°€
        print("ğŸ“ Gitì— ë³€ê²½ì‚¬í•­ ì¶”ê°€ ì¤‘...")
        subprocess.run(['git', 'add', '-A'], check=True)
        
        # ì»¤ë°‹
        commit_message = "ğŸ”„ main ë¸Œëœì¹˜ docs/ ë‚´ìš©ìœ¼ë¡œ ì™„ì „ ë™ê¸°í™”\n\nâœ… ìƒˆë¡œìš´ í†µí•© ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì ìš©\nâœ… ë™ì  ëŒ€ì‹œë³´ë“œ êµ¬ì¡°ë¡œ ì—…ë°ì´íŠ¸\nâœ… ë ˆê±°ì‹œ ì •ì  HTML ì œê±°"
        subprocess.run(['git', 'commit', '-m', commit_message], check=True)
        print("âœ… ì»¤ë°‹ ì™„ë£Œ!")
        
        # ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ
        print("ğŸš€ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ ì¤‘...")
        subprocess.run(['git', 'push', 'origin', 'publish'], check=True)
        print("âœ… í‘¸ì‹œ ì™„ë£Œ!")
        
        # main ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ê¸°
        subprocess.run(['git', 'checkout', 'main'], check=True)
        print(f"ğŸ”„ main ë¸Œëœì¹˜ë¡œ ë³µê·€")
        
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
        shutil.rmtree(temp_dir)
        
        print("ğŸ‰ publish ë¸Œëœì¹˜ ë™ê¸°í™” ì™„ë£Œ!")
        print("ğŸŒ GitHub Pagesê°€ ì—…ë°ì´íŠ¸ë˜ëŠ”ë° ëª‡ ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        print("ğŸ”— ì—…ë°ì´íŠ¸ëœ ì‚¬ì´íŠ¸: https://shuserker.github.io/infomax_api/")
        
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"âŒ Git ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        return False
    except Exception as e:
        print(f"âŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return False

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    success = sync_publish_branch()
    
    if success:
        print("\nğŸ¯ ì´ì œ https://shuserker.github.io/infomax_api/ ì—ì„œ")
        print("   ìƒˆë¡œìš´ í†µí•© ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
    else:
        print("\nâŒ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()