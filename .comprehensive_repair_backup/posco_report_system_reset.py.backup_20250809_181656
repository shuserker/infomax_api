#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Posco Report System Reset
POSCO ì‹œìŠ¤í…œ êµ¬ì„±ìš”ì†Œ

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import os
import sys
import time
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, Optional
import logging
import traceback

# í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

# ê° ì»´í¬ë„ŒíŠ¸ ì„í¬íŠ¸
from report_cleanup_manager import ReportCleanupManager
from integrated_report_builder import IntegratedReportBuilder
from metadata_reset_manager import MetadataResetManager
from legacy_system_disabler import LegacySystemDisabler
from completion_notifier import CompletionNotifier

class PoscoReportSystemReset:
    """
    POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì™„ì „ ì¬êµ¬ì¶• ë©”ì¸ í´ë˜ìŠ¤
    """
    
    def __init__(self):
        """ì´ˆê¸°í™”"""
        # ë¡œê¹… ì„¤ì •
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        self.logger = logging.getLogger(__name__)
        
        # ê° ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
        self.cleanup_manager = ReportCleanupManager()
        self.report_builder = IntegratedReportBuilder()
        self.metadata_manager = MetadataResetManager()
        self.legacy_disabler = LegacySystemDisabler()
        self.notifier = CompletionNotifier()
        
        # ì‹¤í–‰ ê²°ê³¼ ì €ì¥
        self.execution_results = {
            'start_time': None,
            'end_time': None,
            'processing_time': 0,
            'stages': {},
            'overall_success': False,
            'error_info': None
        }
    
    def execute_full_reset(self, start_date: str = '2025-07-25') -> Dict[str, Any]:
        """
        ì „ì²´ ë¦¬ì…‹ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
        
        Args:
            start_date (str): í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ ë‚ ì§œ
            
        Returns:
            Dict[str, Any]: ì „ì²´ ì‹¤í–‰ ê²°ê³¼
        """
        self.execution_results['start_time'] = datetime.now()
        
        self.logger.info("ğŸš€ POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì™„ì „ ì¬êµ¬ì¶• ì‹œì‘!")
        self.logger.info("="*80)
        
        try:
            # 1ë‹¨ê³„: ê¸°ì¡´ ë¦¬í¬íŠ¸ ì™„ì „ ì œê±°
            self.logger.info("\\nğŸ§¹ 1ë‹¨ê³„: ê¸°ì¡´ ë¦¬í¬íŠ¸ ì™„ì „ ì œê±°")
            cleanup_results = self.execute_cleanup_stage()
            self.execution_results['stages']['cleanup'] = cleanup_results
            
            if not cleanup_results.get('success', False):
                raise Exception("ê¸°ì¡´ ë¦¬í¬íŠ¸ ì œê±° ë‹¨ê³„ ì‹¤íŒ¨")
            
            # 2ë‹¨ê³„: ìƒˆë¡œìš´ í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
            self.logger.info("\\nğŸ“Š 2ë‹¨ê³„: ìƒˆë¡œìš´ í†µí•© ë¦¬í¬íŠ¸ ìƒì„±")
            generation_results = self.execute_generation_stage(start_date)
            self.execution_results['stages']['generation'] = generation_results
            
            if not generation_results.get('success', False):
                raise Exception("í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ë‹¨ê³„ ì‹¤íŒ¨")
            
            # 3ë‹¨ê³„: ë©”íƒ€ë°ì´í„° ì´ˆê¸°í™” ë° ì¬êµ¬ì„±
            self.logger.info("\\nğŸ“‹ 3ë‹¨ê³„: ë©”íƒ€ë°ì´í„° ì´ˆê¸°í™” ë° ì¬êµ¬ì„±")
            metadata_results = self.execute_metadata_stage()
            self.execution_results['stages']['metadata'] = metadata_results
            
            if not metadata_results.get('success', False):
                raise Exception("ë©”íƒ€ë°ì´í„° ì¬êµ¬ì„± ë‹¨ê³„ ì‹¤íŒ¨")
            
            # 4ë‹¨ê³„: ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™”
            self.logger.info("\\nğŸš« 4ë‹¨ê³„: ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™”")
            legacy_results = self.execute_legacy_disable_stage()
            self.execution_results['stages']['legacy_disable'] = legacy_results
            
            if not legacy_results.get('success', False):
                raise Exception("ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” ë‹¨ê³„ ì‹¤íŒ¨")
            
            # 5ë‹¨ê³„: ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
            self.logger.info("\\nğŸ“± 5ë‹¨ê³„: ì™„ë£Œ ì•Œë¦¼ ì „ì†¡")
            notification_results = self.execute_notification_stage()
            self.execution_results['stages']['notification'] = notification_results
            
            # ì „ì²´ ì„±ê³µ ì²˜ë¦¬
            self.execution_results['overall_success'] = True
            self.execution_results['end_time'] = datetime.now()
            self.execution_results['processing_time'] = (
                self.execution_results['end_time'] - self.execution_results['start_time']
            ).total_seconds()
            
            # ìµœì¢… ê²°ê³¼ ë¡œê¹…
            self.log_final_results()
            
            return self.execution_results
            
        except Exception as e:
            # ì˜¤ë¥˜ ì²˜ë¦¬
            self.execution_results['overall_success'] = False
            self.execution_results['error_info'] = {
                'error': str(e),
                'traceback': traceback.format_exc(),
                'stage': self.get_current_stage()
            }
            self.execution_results['end_time'] = datetime.now()
            
            self.logger.error(f"âŒ ì‹œìŠ¤í…œ ì¬êµ¬ì¶• ì‹¤íŒ¨: {e}")
            self.logger.error(f"ìƒì„¸ ì˜¤ë¥˜:\\n{traceback.format_exc()}")
            
            # ì˜¤ë¥˜ ì•Œë¦¼ ì „ì†¡
            try:
                self.notifier.send_error_notification(self.execution_results['error_info'])
            except:
                self.logger.error("âŒ ì˜¤ë¥˜ ì•Œë¦¼ ì „ì†¡ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤")
            
            return self.execution_results
    
    def execute_cleanup_stage(self) -> Dict[str, Any]:
        """1ë‹¨ê³„: ê¸°ì¡´ ë¦¬í¬íŠ¸ ì œê±° ì‹¤í–‰"""
        try:
            self.logger.info("ğŸ§¹ ê¸°ì¡´ ë¦¬í¬íŠ¸ íŒŒì¼ ë° ë©”íƒ€ë°ì´í„° ì œê±° ì¤‘...")
            
            # ë°±ì—… ìƒì„±
            backup_path = self.cleanup_manager.backup_existing_data()
            
            # ë¦¬í¬íŠ¸ ì œê±° ì‹¤í–‰
            cleanup_results = self.cleanup_manager.cleanup_all_reports()
            
            return {
                'success': True,
                'backup_path': backup_path,
                'cleanup_results': cleanup_results,
                'removed_files': cleanup_results.get('total_removed_files', 0)
            }
            
        except Exception as e:
            self.logger.error(f"âŒ ë¦¬í¬íŠ¸ ì œê±° ë‹¨ê³„ ì‹¤íŒ¨: {e}")
            return {
                'success': False,
                'error': str(e)
            }
    
    def execute_generation_stage(self, start_date: str) -> Dict[str, Any]:
        """2ë‹¨ê³„: í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì‹¤í–‰"""
        try:
            self.logger.info(f"ğŸ“Š {start_date}ë¶€í„° í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...")
            
            # í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
            generation_results = self.report_builder.generate_date_range_reports(start_date)
            
            # ì„±ê³µí•œ ë¦¬í¬íŠ¸ ê°œìˆ˜ ê³„ì‚°
            successful_reports = [r for r in generation_results if r.get('status') == 'success']
            
            return {
                'success': len(successful_reports) > 0,
                'generation_results': generation_results,
                'total_generated': len(successful_reports),
                'total_attempted': len(generation_results),
                'success_rate': len(successful_reports) / len(generation_results) * 100 if generation_results else 0
            }
            
        except Exception as e:
            self.logger.error(f"âŒ í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ë‹¨ê³„ ì‹¤íŒ¨: {e}")
            return {
                'success': False,
                'error': str(e)
            }
    
    def execute_metadata_stage(self) -> Dict[str, Any]:
        """3ë‹¨ê³„: ë©”íƒ€ë°ì´í„° ì¬êµ¬ì„± ì‹¤í–‰"""
        try:
            self.logger.info("ğŸ“‹ ë©”íƒ€ë°ì´í„° ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ì¬êµ¬ì„± ì¤‘...")
            
            # ë©”íƒ€ë°ì´í„° ì´ˆê¸°í™”
            reset_success = self.metadata_manager.reset_metadata_index()
            
            # í†µí•© ë¦¬í¬íŠ¸ ìŠ¤ìº” ë° ë“±ë¡
            registration_results = self.metadata_manager.scan_and_register_integrated_reports()
            
            # í†µê³„ ì—…ë°ì´íŠ¸
            statistics = self.metadata_manager.update_report_statistics()
            
            # ë¬´ê²°ì„± ê²€ì¦
            integrity_results = self.metadata_manager.validate_metadata_integrity()
            
            return {
                'success': reset_success and registration_results.get('successfully_registered', 0) > 0,
                'reset_success': reset_success,
                'registration_results': registration_results,
                'statistics': statistics,
                'integrity_results': integrity_results
            }
            
        except Exception as e:
            self.logger.error(f"âŒ ë©”íƒ€ë°ì´í„° ì¬êµ¬ì„± ë‹¨ê³„ ì‹¤íŒ¨: {e}")
            return {
                'success': False,
                'error': str(e)
            }
    
    def execute_legacy_disable_stage(self) -> Dict[str, Any]:
        """4ë‹¨ê³„: ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” ì‹¤í–‰"""
        try:
            self.logger.info("ğŸš« ê°œë³„ ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” ì¤‘...")
            
            # ê°œë³„ ëª¨ë‹ˆí„° ë¹„í™œì„±í™”
            monitor_results = self.legacy_disabler.disable_individual_monitors()
            
            # ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • ì—…ë°ì´íŠ¸
            scheduler_success = self.legacy_disabler.update_scheduler_config()
            
            # ì‹œìŠ¤í…œ ìƒíƒœ íŒŒì¼ ìƒì„±
            status_file_success = self.legacy_disabler.create_system_status_file()
            
            # ì‹œìŠ¤í…œ ìƒíƒœ ê²€ì¦
            validation_results = self.legacy_disabler.validate_system_state()
            
            return {
                'success': all(monitor_results.values()) and scheduler_success and status_file_success,
                'monitor_results': monitor_results,
                'scheduler_success': scheduler_success,
                'status_file_success': status_file_success,
                'validation_results': validation_results
            }
            
        except Exception as e:
            self.logger.error(f"âŒ ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™” ë‹¨ê³„ ì‹¤íŒ¨: {e}")
            return {
                'success': False,
                'error': str(e)
            }
    
    def execute_notification_stage(self) -> Dict[str, Any]:
        """5ë‹¨ê³„: ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì‹¤í–‰"""
        try:
            self.logger.info("ğŸ“± ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì¤‘...")
            
            # ì•Œë¦¼ ë°ì´í„° ì¤€ë¹„
            notification_data = {
                'cleanup_results': self.execution_results['stages']['cleanup']['cleanup_results'],
                'generation_results': self.execution_results['stages']['generation']['generation_results'],
                'metadata_results': self.execution_results['stages']['metadata'],
                'processing_time': (datetime.now() - self.execution_results['start_time']).total_seconds()
            }
            
            # ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
            notification_success = self.notifier.send_completion_notification(notification_data)
            
            return {
                'success': notification_success,
                'notification_sent': notification_success
            }
            
        except Exception as e:
            self.logger.error(f"âŒ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ë‹¨ê³„ ì‹¤íŒ¨: {e}")
            return {
                'success': False,
                'error': str(e),
                'notification_sent': False
            }
    
    def get_current_stage(self) -> str:
        """í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë‹¨ê³„ ë°˜í™˜"""
        stages = ['cleanup', 'generation', 'metadata', 'legacy_disable', 'notification']
        
        for stage in stages:
            if stage not in self.execution_results['stages']:
                return stage
        
        return 'unknown'
    
    def log_final_results(self):
        """ìµœì¢… ê²°ê³¼ ë¡œê¹…"""
        self.logger.info("\\n" + "="*80)
        self.logger.info("ğŸ‰ POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì™„ì „ ì¬êµ¬ì¶• ì™„ë£Œ!")
        self.logger.info("="*80)
        
        # ê° ë‹¨ê³„ë³„ ê²°ê³¼ ìš”ì•½
        cleanup = self.execution_results['stages']['cleanup']
        generation = self.execution_results['stages']['generation']
        metadata = self.execution_results['stages']['metadata']
        legacy = self.execution_results['stages']['legacy_disable']
        notification = self.execution_results['stages']['notification']
        
        self.logger.info(f"ğŸ§¹ 1ë‹¨ê³„ - ê¸°ì¡´ ë¦¬í¬íŠ¸ ì œê±°: {cleanup['removed_files']}ê°œ íŒŒì¼")
        self.logger.info(f"ğŸ“Š 2ë‹¨ê³„ - í†µí•© ë¦¬í¬íŠ¸ ìƒì„±: {generation['total_generated']}ê°œ ìƒì„±")
        self.logger.info(f"ğŸ“‹ 3ë‹¨ê³„ - ë©”íƒ€ë°ì´í„° ì¬êµ¬ì„±: {metadata['registration_results']['successfully_registered']}ê°œ ë“±ë¡")
        self.logger.info(f"ğŸš« 4ë‹¨ê³„ - ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ë¹„í™œì„±í™”: {sum(1 for v in legacy['monitor_results'].values() if v)}/3 ì„±ê³µ")
        self.logger.info(f"ğŸ“± 5ë‹¨ê³„ - ì™„ë£Œ ì•Œë¦¼ ì „ì†¡: {'ì„±ê³µ' if notification['notification_sent'] else 'ì‹¤íŒ¨'}")
        
        self.logger.info(f"\\nâ±ï¸ ì´ ì²˜ë¦¬ ì‹œê°„: {self.execution_results['processing_time']:.1f}ì´ˆ")
        self.logger.info(f"âœ… ì „ì²´ ì„±ê³µë¥ : 100%")
        
        # ëŒ€ì‹œë³´ë“œ ë§í¬
        self.logger.info("\\nğŸ”— í™•ì¸ ê°€ëŠ¥í•œ ë§í¬:")
        self.logger.info("  ğŸ“Š ëŒ€ì‹œë³´ë“œ: https://shuserker.github.io/infomax_api/")
        self.logger.info("  ğŸ“‹ ë¦¬í¬íŠ¸ API: https://shuserker.github.io/infomax_api/docs/reports_index.json")
        
        self.logger.info("\\nğŸ¯ ì‹œìŠ¤í…œ ì „í™˜ ì™„ë£Œ:")
        self.logger.info("  â€¢ ê°œë³„ ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ â†’ í†µí•© ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ")
        self.logger.info("  â€¢ ê¸°ì¡´ 88ê°œ ë¦¬í¬íŠ¸ ì œê±° â†’ ìƒˆë¡œìš´ í†µí•© ë¦¬í¬íŠ¸ ìƒì„±")
        self.logger.info("  â€¢ ë©”íƒ€ë°ì´í„° ì‹œìŠ¤í…œ ì™„ì „ ì¬êµ¬ì„±")
        self.logger.info("  â€¢ ë ˆê±°ì‹œ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ ë¹„í™œì„±í™”")

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("ğŸš€ POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì™„ì „ ì¬êµ¬ì¶•ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    print("âš ï¸ ì´ ì‘ì—…ì€ ê¸°ì¡´ ëª¨ë“  ë¦¬í¬íŠ¸ë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ ì‹œìŠ¤í…œìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.")
    print()
    
    # ì‚¬ìš©ì í™•ì¸
    try:
        confirm = input("ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ").lower().strip()
        if confirm not in ['yes', 'y']:
            print("âŒ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            return False
    except KeyboardInterrupt:
        print("\\nâŒ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return False
    
    # ì‹œì‘ ë‚ ì§œ ì…ë ¥
    try:
        start_date = input("í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘ ë‚ ì§œ (YYYY-MM-DD, ê¸°ë³¸ê°’: 2025-07-25): ").strip()
        if not start_date:
            start_date = '2025-07-25'
    except KeyboardInterrupt:
        print("\\nâŒ ì‘ì—…ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return False
    
    print(f"\\nğŸ¯ ì„¤ì •ëœ ì‹œì‘ ë‚ ì§œ: {start_date}")
    print("\\n" + "="*60)
    
    # ì‹œìŠ¤í…œ ì¬êµ¬ì¶• ì‹¤í–‰
    reset_system = PoscoReportSystemReset()
    results = reset_system.execute_full_reset(start_date)
    
    # ê²°ê³¼ ë°˜í™˜
    if results['overall_success']:
        print("\\nğŸ‰ POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì¬êµ¬ì¶•ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        return True
    else:
        print("\\nâŒ POSCO ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ ì¬êµ¬ì¶• ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
        print(f"ì˜¤ë¥˜: {results.get('error_info', {}).get('error', 'Unknown error')}")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)