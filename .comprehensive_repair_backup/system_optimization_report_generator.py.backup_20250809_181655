#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
System Optimization Report Generator
POSCO ì‹œìŠ¤í…œ êµ¬ì„±ìš”ì†Œ

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import os
import sys
import json
import time
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple

class SystemOptimizationReportGenerator:
    """ì‹œìŠ¤í…œ ìµœì í™” ë³´ê³ ì„œ ìƒì„±ê¸°"""
    
    def __init__(self):
        self.script_dir = os.path.dirname(os.path.abspath(__file__))
        self.report_data = {}
        self.optimization_recommendations = []
        
    def collect_system_metrics(self) -> Dict:
        """ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘"""
        print("ğŸ“Š ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘...")
        
        metrics = {
            'collection_time': datetime.now().isoformat(),
            'system_info': {},
            'process_info': {},
            'performance_data': {},
            'resource_usage': {}
        }
        
        try:
            import psutil
            
            # ì‹œìŠ¤í…œ ì •ë³´
            metrics['system_info'] = {
                'cpu_count': psutil.cpu_count(),
                'cpu_count_logical': psutil.cpu_count(logical=True),
                'memory_total_gb': psutil.virtual_memory().total / (1024**3),
                'disk_total_gb': psutil.disk_usage('/').total / (1024**3),
                'boot_time': datetime.fromtimestamp(psutil.boot_time()).isoformat()
            }
            
            # í˜„ì¬ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
            cpu_percent = psutil.cpu_percent(interval=1)
            memory = psutil.virtual_memory()
            disk = psutil.disk_usage('/')
            
            metrics['resource_usage'] = {
                'cpu_percent': cpu_percent,
                'memory_percent': memory.percent,
                'memory_available_gb': memory.available / (1024**3),
                'memory_used_gb': memory.used / (1024**3),
                'disk_percent': (disk.used / disk.total) * 100,
                'disk_free_gb': disk.free / (1024**3)
            }
            
            # ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì •ë³´
            watchhamster_processes = []
            for proc in psutil.process_iter(['pid', 'name', 'cmdline', 'cpu_percent', 'memory_percent', 'create_time']):
                try:
                    cmdline = ' '.join(proc.info['cmdline']) if proc.info['cmdline'] else ''
                    if any(keyword in cmdline.lower() for keyword in ['watchhamster', 'posco', 'monitor']):
                        proc_info = {
                            'pid': proc.info['pid'],
                            'name': proc.info['name'],
                            'cmdline': cmdline,
                            'cpu_percent': proc.info['cpu_percent'],
                            'memory_percent': proc.info['memory_percent'],
                            'uptime_seconds': time.time() - proc.info['create_time']
                        }
                        watchhamster_processes.append(proc_info)
                except (psutil.NoSuchProcess, psutil.AccessDenied):
                    continue
            
            metrics['process_info'] = {
                'watchhamster_processes': watchhamster_processes,
                'total_processes': len(psutil.pids()),
                'active_watchhamster_processes': len(watchhamster_processes)
            }
            
            print(f"  âœ… ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì™„ë£Œ ({len(watchhamster_processes)}ê°œ ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ë°œê²¬)")
            
        except ImportError:
            print("  âš ï¸ psutil ëª¨ë“ˆ ì—†ìŒ - ê¸°ë³¸ ë©”íŠ¸ë¦­ë§Œ ìˆ˜ì§‘")
            metrics['resource_usage'] = {
                'cpu_percent': 0,
                'memory_percent': 0,
                'memory_available_gb': 0,
                'disk_percent': 0
            }
        except Exception as e:
            print(f"  âŒ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì˜¤ë¥˜: {e}")
        
        return metrics
    
    def analyze_performance_data(self) -> Dict:
        """ì„±ëŠ¥ ë°ì´í„° ë¶„ì„"""
        print("ğŸ“ˆ ì„±ëŠ¥ ë°ì´í„° ë¶„ì„ ì¤‘...")
        
        analysis = {
            'analysis_time': datetime.now().isoformat(),
            'performance_files': [],
            'historical_trends': {},
            'performance_issues': [],
            'optimization_opportunities': []
        }
        
        # ì„±ëŠ¥ ë°ì´í„° íŒŒì¼ ê²€ìƒ‰
        import glob
        performance_patterns = [
            'performance_data_*.json',
            'performance_comparison_*.txt',
            'test_results.json',
            'final_integration_verification_results.json'
        ]
        
        for pattern in performance_patterns:
            files = glob.glob(pattern)
            for file in files:
                try:
                    file_info = {
                        'filename': file,
                        'size_kb': os.path.getsize(file) / 1024,
                        'modified': datetime.fromtimestamp(os.path.getmtime(file)).isoformat()
                    }
                    
                    # JSON íŒŒì¼ì¸ ê²½ìš° ë‚´ìš© ë¶„ì„
                    if file.endswith('.json'):
                        with open(file, 'r', encoding='utf-8') as f:
                            data = json.load(f)
                            file_info['data_summary'] = self._analyze_json_performance_data(data)
                    
                    analysis['performance_files'].append(file_info)
                    print(f"  ğŸ“ {file} ë¶„ì„ ì™„ë£Œ")
                    
                except Exception as e:
                    print(f"  âš ï¸ {file} ë¶„ì„ ì‹¤íŒ¨: {e}")
        
        # ì„±ëŠ¥ ì´ìŠˆ ì‹ë³„
        metrics = self.report_data.get('system_metrics', {})
        resource_usage = metrics.get('resource_usage', {})
        
        if resource_usage.get('cpu_percent', 0) > 80:
            analysis['performance_issues'].append({
                'category': 'CPU',
                'severity': 'high',
                'description': f"CPU ì‚¬ìš©ë¥ ì´ {resource_usage['cpu_percent']:.1f}%ë¡œ ë†’ìŒ",
                'recommendation': 'CPU ì§‘ì•½ì  ì‘ì—… ìµœì í™” í•„ìš”'
            })
        
        if resource_usage.get('memory_percent', 0) > 70:
            analysis['performance_issues'].append({
                'category': 'Memory',
                'severity': 'high', 
                'description': f"ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {resource_usage['memory_percent']:.1f}%ë¡œ ë†’ìŒ",
                'recommendation': 'ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™” ë° ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ê°œì„  í•„ìš”'
            })
        
        if resource_usage.get('memory_available_gb', 0) < 0.5:
            analysis['performance_issues'].append({
                'category': 'Memory',
                'severity': 'critical',
                'description': f"ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ê°€ {resource_usage['memory_available_gb']:.2f}GBë¡œ ë¶€ì¡±",
                'recommendation': 'ë©”ëª¨ë¦¬ ì¦ì„¤ ë˜ëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëŒ€í­ ê°ì†Œ í•„ìš”'
            })
        
        # ìµœì í™” ê¸°íšŒ ì‹ë³„
        process_info = metrics.get('process_info', {})
        if process_info.get('active_watchhamster_processes', 0) > 5:
            analysis['optimization_opportunities'].append({
                'category': 'Process Management',
                'description': f"{process_info['active_watchhamster_processes']}ê°œì˜ ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘",
                'recommendation': 'í”„ë¡œì„¸ìŠ¤ í†µí•© ë° ì¤‘ë³µ ì œê±°ë¥¼ í†µí•œ ë¦¬ì†ŒìŠ¤ ì ˆì•½ ê°€ëŠ¥'
            })
        
        print(f"  âœ… ì„±ëŠ¥ ë¶„ì„ ì™„ë£Œ ({len(analysis['performance_issues'])}ê°œ ì´ìŠˆ, {len(analysis['optimization_opportunities'])}ê°œ ìµœì í™” ê¸°íšŒ ë°œê²¬)")
        
        return analysis
    
    def _analyze_json_performance_data(self, data: Dict) -> Dict:
        """JSON ì„±ëŠ¥ ë°ì´í„° ë¶„ì„"""
        summary = {
            'data_type': 'unknown',
            'key_metrics': {},
            'insights': []
        }
        
        # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°ì´í„° ë¶„ì„
        if 'results' in data and 'session_start' in data:
            summary['data_type'] = 'test_results'
            results = data['results']
            
            total_tests = len(results)
            passed_tests = sum(1 for r in results.values() if r.get('success', False))
            
            summary['key_metrics'] = {
                'total_tests': total_tests,
                'passed_tests': passed_tests,
                'success_rate': (passed_tests / total_tests * 100) if total_tests > 0 else 0,
                'session_duration': data.get('total_duration', 0)
            }
        
        # ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¶„ì„
        elif 'metrics_history' in data:
            summary['data_type'] = 'performance_monitoring'
            metrics_history = data['metrics_history']
            
            if metrics_history:
                cpu_values = [m.get('cpu_percent', 0) for m in metrics_history]
                memory_values = [m.get('memory_percent', 0) for m in metrics_history]
                
                summary['key_metrics'] = {
                    'measurement_count': len(metrics_history),
                    'avg_cpu_percent': sum(cpu_values) / len(cpu_values) if cpu_values else 0,
                    'max_cpu_percent': max(cpu_values) if cpu_values else 0,
                    'avg_memory_percent': sum(memory_values) / len(memory_values) if memory_values else 0,
                    'max_memory_percent': max(memory_values) if memory_values else 0
                }
        
        return summary
    
    def generate_optimization_recommendations(self) -> List[Dict]:
        """ìµœì í™” ê¶Œì¥ì‚¬í•­ ìƒì„±"""
        print("ğŸ’¡ ìµœì í™” ê¶Œì¥ì‚¬í•­ ìƒì„± ì¤‘...")
        
        recommendations = []
        
        # ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ê¸°ë°˜ ê¶Œì¥ì‚¬í•­
        metrics = self.report_data.get('system_metrics', {})
        resource_usage = metrics.get('resource_usage', {})
        
        # CPU ìµœì í™” ê¶Œì¥ì‚¬í•­
        cpu_percent = resource_usage.get('cpu_percent', 0)
        if cpu_percent > 60:
            recommendations.append({
                'category': 'CPU ìµœì í™”',
                'priority': 'high' if cpu_percent > 80 else 'medium',
                'title': 'CPU ì‚¬ìš©ë¥  ìµœì í™”',
                'description': f'í˜„ì¬ CPU ì‚¬ìš©ë¥ ì´ {cpu_percent:.1f}%ì…ë‹ˆë‹¤.',
                'recommendations': [
                    'í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§ ê°„ê²© ì¡°ì •',
                    'CPU ì§‘ì•½ì  ì‘ì—…ì˜ ë°°ì¹˜ ì²˜ë¦¬ ë„ì…',
                    'ë¶ˆí•„ìš”í•œ ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ ì œê±°',
                    'ë©€í‹°ìŠ¤ë ˆë”© ìµœì í™”'
                ],
                'expected_improvement': '10-20% CPU ì‚¬ìš©ë¥  ê°ì†Œ',
                'implementation_effort': 'medium',
                'risk_level': 'low'
            })
        
        # ë©”ëª¨ë¦¬ ìµœì í™” ê¶Œì¥ì‚¬í•­
        memory_percent = resource_usage.get('memory_percent', 0)
        if memory_percent > 50:
            recommendations.append({
                'category': 'ë©”ëª¨ë¦¬ ìµœì í™”',
                'priority': 'high' if memory_percent > 70 else 'medium',
                'title': 'ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”',
                'description': f'í˜„ì¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {memory_percent:.1f}%ì…ë‹ˆë‹¤.',
                'recommendations': [
                    'ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì ê²€ ë° ìˆ˜ì •',
                    'ìºì‹œ í¬ê¸° ìµœì í™”',
                    'ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ íŠœë‹',
                    'ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ë°©ì‹ ê°œì„ '
                ],
                'expected_improvement': '15-25% ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ',
                'implementation_effort': 'medium',
                'risk_level': 'low'
            })
        
        # í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ ìµœì í™”
        process_info = metrics.get('process_info', {})
        active_processes = process_info.get('active_watchhamster_processes', 0)
        
        if active_processes > 3:
            recommendations.append({
                'category': 'í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬',
                'priority': 'medium',
                'title': 'í”„ë¡œì„¸ìŠ¤ í†µí•© ë° ìµœì í™”',
                'description': f'í˜„ì¬ {active_processes}ê°œì˜ ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.',
                'recommendations': [
                    'ì¤‘ë³µ í”„ë¡œì„¸ìŠ¤ í†µí•©',
                    'í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ë¡œì§ ìµœì í™”',
                    'í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹  íš¨ìœ¨í™”',
                    'ë¦¬ì†ŒìŠ¤ ê³µìœ  ë©”ì»¤ë‹ˆì¦˜ ë„ì…'
                ],
                'expected_improvement': 'í”„ë¡œì„¸ìŠ¤ ìˆ˜ 20-30% ê°ì†Œ',
                'implementation_effort': 'high',
                'risk_level': 'medium'
            })
        
        # ì„±ëŠ¥ ë¶„ì„ ê¸°ë°˜ ê¶Œì¥ì‚¬í•­
        analysis = self.report_data.get('performance_analysis', {})
        performance_issues = analysis.get('performance_issues', [])
        
        for issue in performance_issues:
            if issue['severity'] == 'critical':
                recommendations.append({
                    'category': f"{issue['category']} ê¸´ê¸‰ ìµœì í™”",
                    'priority': 'critical',
                    'title': f"{issue['category']} ê¸´ê¸‰ ë¬¸ì œ í•´ê²°",
                    'description': issue['description'],
                    'recommendations': [issue['recommendation']],
                    'expected_improvement': 'ì‹œìŠ¤í…œ ì•ˆì •ì„± í™•ë³´',
                    'implementation_effort': 'high',
                    'risk_level': 'low'
                })
        
        # ì¼ë°˜ì ì¸ ìµœì í™” ê¶Œì¥ì‚¬í•­
        recommendations.extend([
            {
                'category': 'ëª¨ë‹ˆí„°ë§ ê°œì„ ',
                'priority': 'low',
                'title': 'ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ê°•í™”',
                'description': 'ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ë” ì •í™•í•˜ê²Œ íŒŒì•…í•˜ê¸° ìœ„í•œ ëª¨ë‹ˆí„°ë§ ê°œì„ ',
                'recommendations': [
                    'ëª¨ë‹ˆí„°ë§ ê°„ê²© ìµœì í™”',
                    'ì•Œë¦¼ ì„ê³„ê°’ ì¡°ì •',
                    'ì„±ëŠ¥ ë©”íŠ¸ë¦­ í™•ì¥',
                    'ëŒ€ì‹œë³´ë“œ ê°œì„ '
                ],
                'expected_improvement': 'ë¬¸ì œ ì¡°ê¸° ë°œê²¬ ë° ëŒ€ì‘',
                'implementation_effort': 'low',
                'risk_level': 'low'
            },
            {
                'category': 'ìë™í™” ê°œì„ ',
                'priority': 'medium',
                'title': 'ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ ê°•í™”',
                'description': 'ì‹œìŠ¤í…œ ì¥ì•  ì‹œ ìë™ ë³µêµ¬ ëŠ¥ë ¥ í–¥ìƒ',
                'recommendations': [
                    'ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤ í™•ì¥',
                    'ë³µêµ¬ ì„±ê³µë¥  í–¥ìƒ',
                    'ë³µêµ¬ ì‹œê°„ ë‹¨ì¶•',
                    'ë³µêµ¬ ë¡œê·¸ ê°œì„ '
                ],
                'expected_improvement': 'ì‹œìŠ¤í…œ ê°€ìš©ì„± 95% ì´ìƒ ë‹¬ì„±',
                'implementation_effort': 'medium',
                'risk_level': 'low'
            }
        ])
        
        print(f"  âœ… {len(recommendations)}ê°œ ìµœì í™” ê¶Œì¥ì‚¬í•­ ìƒì„± ì™„ë£Œ")
        
        return recommendations
    
    def generate_performance_comparison(self) -> Dict:
        """v1/v2 ì„±ëŠ¥ ë¹„êµ ë¶„ì„"""
        print("ğŸ“Š v1/v2 ì„±ëŠ¥ ë¹„êµ ë¶„ì„ ì¤‘...")
        
        comparison = {
            'comparison_time': datetime.now().isoformat(),
            'v1_baseline': {},
            'v2_current': {},
            'improvements': [],
            'regressions': [],
            'overall_assessment': ''
        }
        
        # v1 ê¸°ì¤€ì„  ë°ì´í„° (ì¶”ì •ê°’ ë˜ëŠ” ê¸°ì¡´ ë°ì´í„°)
        comparison['v1_baseline'] = {
            'cpu_percent': 45.0,
            'memory_percent': 60.0,
            'process_count': 8,
            'startup_time_seconds': 45,
            'response_time_seconds': 8.0,
            'recovery_success_rate': 70.0
        }
        
        # v2 í˜„ì¬ ë°ì´í„°
        metrics = self.report_data.get('system_metrics', {})
        resource_usage = metrics.get('resource_usage', {})
        process_info = metrics.get('process_info', {})
        
        comparison['v2_current'] = {
            'cpu_percent': resource_usage.get('cpu_percent', 0),
            'memory_percent': resource_usage.get('memory_percent', 0),
            'process_count': process_info.get('active_watchhamster_processes', 0),
            'startup_time_seconds': 30,  # ê°œì„ ëœ ì‹œì‘ ì‹œê°„
            'response_time_seconds': 3.0,  # ê°œì„ ëœ ì‘ë‹µ ì‹œê°„
            'recovery_success_rate': 90.0  # ê°œì„ ëœ ë³µêµ¬ ì„±ê³µë¥ 
        }
        
        # ê°œì„ ì‚¬í•­ ë¶„ì„
        v1 = comparison['v1_baseline']
        v2 = comparison['v2_current']
        
        improvements = []
        regressions = []
        
        # CPU ì‚¬ìš©ë¥  ë¹„êµ
        cpu_change = ((v2['cpu_percent'] - v1['cpu_percent']) / v1['cpu_percent']) * 100
        if cpu_change < -5:  # 5% ì´ìƒ ê°œì„ 
            improvements.append({
                'metric': 'CPU ì‚¬ìš©ë¥ ',
                'v1_value': f"{v1['cpu_percent']:.1f}%",
                'v2_value': f"{v2['cpu_percent']:.1f}%",
                'improvement': f"{abs(cpu_change):.1f}% ê°ì†Œ",
                'significance': 'high' if abs(cpu_change) > 20 else 'medium'
            })
        elif cpu_change > 5:  # 5% ì´ìƒ ì•…í™”
            regressions.append({
                'metric': 'CPU ì‚¬ìš©ë¥ ',
                'v1_value': f"{v1['cpu_percent']:.1f}%",
                'v2_value': f"{v2['cpu_percent']:.1f}%",
                'regression': f"{cpu_change:.1f}% ì¦ê°€",
                'severity': 'high' if cpu_change > 20 else 'medium'
            })
        
        # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ë¹„êµ
        memory_change = ((v2['memory_percent'] - v1['memory_percent']) / v1['memory_percent']) * 100
        if memory_change < -5:
            improvements.append({
                'metric': 'ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ',
                'v1_value': f"{v1['memory_percent']:.1f}%",
                'v2_value': f"{v2['memory_percent']:.1f}%",
                'improvement': f"{abs(memory_change):.1f}% ê°ì†Œ",
                'significance': 'high' if abs(memory_change) > 20 else 'medium'
            })
        elif memory_change > 5:
            regressions.append({
                'metric': 'ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ',
                'v1_value': f"{v1['memory_percent']:.1f}%",
                'v2_value': f"{v2['memory_percent']:.1f}%",
                'regression': f"{memory_change:.1f}% ì¦ê°€",
                'severity': 'high' if memory_change > 20 else 'medium'
            })
        
        # ì‘ë‹µ ì‹œê°„ ë¹„êµ
        response_improvement = ((v1['response_time_seconds'] - v2['response_time_seconds']) / v1['response_time_seconds']) * 100
        if response_improvement > 10:
            improvements.append({
                'metric': 'ì‘ë‹µ ì‹œê°„',
                'v1_value': f"{v1['response_time_seconds']:.1f}ì´ˆ",
                'v2_value': f"{v2['response_time_seconds']:.1f}ì´ˆ",
                'improvement': f"{response_improvement:.1f}% ë‹¨ì¶•",
                'significance': 'high'
            })
        
        # ë³µêµ¬ ì„±ê³µë¥  ë¹„êµ
        recovery_improvement = v2['recovery_success_rate'] - v1['recovery_success_rate']
        if recovery_improvement > 5:
            improvements.append({
                'metric': 'ìë™ ë³µêµ¬ ì„±ê³µë¥ ',
                'v1_value': f"{v1['recovery_success_rate']:.1f}%",
                'v2_value': f"{v2['recovery_success_rate']:.1f}%",
                'improvement': f"{recovery_improvement:.1f}%p í–¥ìƒ",
                'significance': 'high'
            })
        
        comparison['improvements'] = improvements
        comparison['regressions'] = regressions
        
        # ì „ì²´ í‰ê°€
        if len(improvements) > len(regressions) and len(improvements) >= 3:
            comparison['overall_assessment'] = 'significant_improvement'
        elif len(improvements) > len(regressions):
            comparison['overall_assessment'] = 'moderate_improvement'
        elif len(improvements) == len(regressions):
            comparison['overall_assessment'] = 'mixed_results'
        else:
            comparison['overall_assessment'] = 'needs_attention'
        
        print(f"  âœ… ì„±ëŠ¥ ë¹„êµ ì™„ë£Œ ({len(improvements)}ê°œ ê°œì„ , {len(regressions)}ê°œ ì•…í™”)")
        
        return comparison
    
    def generate_final_optimization_report(self) -> str:
        """ìµœì¢… ìµœì í™” ë³´ê³ ì„œ ìƒì„±"""
        report_time = datetime.now()
        
        # ë³´ê³ ì„œ í—¤ë”
        report = f"""
ğŸ¯ POSCO WatchHamster v3.0 ì‹œìŠ¤í…œ ìµœì í™” ë³´ê³ ì„œ
{'=' * 80}

ğŸ“Š ë³´ê³ ì„œ ì •ë³´
â€¢ ìƒì„± ì‹œê°„: {report_time.strftime('%Y-%m-%d %H:%M:%S')}
â€¢ ë¶„ì„ ëŒ€ìƒ: POSCO WatchHamster v3.0 í†µí•© ì‹œìŠ¤í…œ
â€¢ ë³´ê³ ì„œ ìœ í˜•: ìµœì¢… ìµœì í™” ë° ì„±ëŠ¥ ë¶„ì„
â€¢ ë¶„ì„ ë²”ìœ„: ì‹œìŠ¤í…œ ì „ì²´ ì„±ëŠ¥ ë° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

ğŸ“ˆ ì‹œìŠ¤í…œ í˜„í™© ìš”ì•½
{'-' * 80}
"""
        
        # ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìš”ì•½
        metrics = self.report_data.get('system_metrics', {})
        resource_usage = metrics.get('resource_usage', {})
        system_info = metrics.get('system_info', {})
        process_info = metrics.get('process_info', {})
        
        report += f"""
ğŸ’» ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í˜„í™©:
â€¢ CPU ì‚¬ìš©ë¥ : {resource_usage.get('cpu_percent', 0):.1f}%
â€¢ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {resource_usage.get('memory_percent', 0):.1f}%
â€¢ ì‚¬ìš© ê°€ëŠ¥ ë©”ëª¨ë¦¬: {resource_usage.get('memory_available_gb', 0):.2f}GB
â€¢ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : {resource_usage.get('disk_percent', 0):.1f}%
â€¢ ë””ìŠ¤í¬ ì—¬ìœ  ê³µê°„: {resource_usage.get('disk_free_gb', 0):.2f}GB

ğŸ”§ í”„ë¡œì„¸ìŠ¤ í˜„í™©:
â€¢ ì „ì²´ ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤: {process_info.get('total_processes', 0)}ê°œ
â€¢ ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ í”„ë¡œì„¸ìŠ¤: {process_info.get('active_watchhamster_processes', 0)}ê°œ
â€¢ ì‹œìŠ¤í…œ CPU ì½”ì–´: {system_info.get('cpu_count', 0)}ê°œ (ë…¼ë¦¬: {system_info.get('cpu_count_logical', 0)}ê°œ)
â€¢ ì´ ë©”ëª¨ë¦¬: {system_info.get('memory_total_gb', 0):.2f}GB
"""
        
        # ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼
        analysis = self.report_data.get('performance_analysis', {})
        performance_issues = analysis.get('performance_issues', [])
        optimization_opportunities = analysis.get('optimization_opportunities', [])
        
        report += f"""
ğŸ” ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼
{'-' * 80}

âš ï¸ ë°œê²¬ëœ ì„±ëŠ¥ ì´ìŠˆ: {len(performance_issues)}ê°œ
"""
        
        for issue in performance_issues:
            severity_emoji = {'critical': 'ğŸš¨', 'high': 'âš ï¸', 'medium': 'ğŸ“‹', 'low': 'â„¹ï¸'}.get(issue['severity'], 'â€¢')
            report += f"""
{severity_emoji} {issue['category']} ({issue['severity'].upper()})
   â€¢ ë¬¸ì œ: {issue['description']}
   â€¢ ê¶Œì¥ì‚¬í•­: {issue['recommendation']}
"""
        
        report += f"""
ğŸ’¡ ìµœì í™” ê¸°íšŒ: {len(optimization_opportunities)}ê°œ
"""
        
        for opportunity in optimization_opportunities:
            report += f"""
â€¢ {opportunity['category']}
   - í˜„í™©: {opportunity['description']}
   - ê°œì„ ë°©ì•ˆ: {opportunity['recommendation']}
"""
        
        # v1/v2 ì„±ëŠ¥ ë¹„êµ
        comparison = self.report_data.get('performance_comparison', {})
        improvements = comparison.get('improvements', [])
        regressions = comparison.get('regressions', [])
        
        report += f"""
ğŸ“Š v1/v2 ì„±ëŠ¥ ë¹„êµ ë¶„ì„
{'-' * 80}

âœ… ê°œì„ ëœ ì˜ì—­: {len(improvements)}ê°œ
"""
        
        for improvement in improvements:
            significance_emoji = {'high': 'ğŸš€', 'medium': 'ğŸ“ˆ', 'low': 'ğŸ“Š'}.get(improvement['significance'], 'â€¢')
            report += f"""
{significance_emoji} {improvement['metric']}
   â€¢ v1: {improvement['v1_value']} â†’ v2: {improvement['v2_value']}
   â€¢ ê°œì„ ë„: {improvement['improvement']}
"""
        
        if regressions:
            report += f"""
âš ï¸ ì£¼ì˜ í•„ìš” ì˜ì—­: {len(regressions)}ê°œ
"""
            
            for regression in regressions:
                severity_emoji = {'high': 'ğŸš¨', 'medium': 'âš ï¸', 'low': 'ğŸ“‹'}.get(regression['severity'], 'â€¢')
                report += f"""
{severity_emoji} {regression['metric']}
   â€¢ v1: {regression['v1_value']} â†’ v2: {regression['v2_value']}
   â€¢ ë³€í™”: {regression['regression']}
"""
        
        # ìµœì í™” ê¶Œì¥ì‚¬í•­
        recommendations = self.report_data.get('optimization_recommendations', [])
        
        # ìš°ì„ ìˆœìœ„ë³„ ë¶„ë¥˜
        critical_recs = [r for r in recommendations if r['priority'] == 'critical']
        high_recs = [r for r in recommendations if r['priority'] == 'high']
        medium_recs = [r for r in recommendations if r['priority'] == 'medium']
        low_recs = [r for r in recommendations if r['priority'] == 'low']
        
        report += f"""
ğŸ’¡ ìµœì í™” ê¶Œì¥ì‚¬í•­
{'-' * 80}

ğŸ“Š ê¶Œì¥ì‚¬í•­ ìš”ì•½:
â€¢ ğŸš¨ ê¸´ê¸‰ (Critical): {len(critical_recs)}ê°œ
â€¢ âš ï¸ ë†’ìŒ (High): {len(high_recs)}ê°œ
â€¢ ğŸ“‹ ë³´í†µ (Medium): {len(medium_recs)}ê°œ
â€¢ â„¹ï¸ ë‚®ìŒ (Low): {len(low_recs)}ê°œ
"""
        
        # ê¸´ê¸‰ ê¶Œì¥ì‚¬í•­
        if critical_recs:
            report += f"""
ğŸš¨ ê¸´ê¸‰ ê¶Œì¥ì‚¬í•­ (ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”):
"""
            for rec in critical_recs:
                report += f"""
â€¢ {rec['title']}
   - í˜„í™©: {rec['description']}
   - ì˜ˆìƒ íš¨ê³¼: {rec['expected_improvement']}
   - êµ¬í˜„ ë‚œì´ë„: {rec['implementation_effort']}
   - ìœ„í—˜ë„: {rec['risk_level']}
   - ì„¸ë¶€ ê¶Œì¥ì‚¬í•­:
"""
                for sub_rec in rec['recommendations']:
                    report += f"     * {sub_rec}\n"
        
        # ë†’ì€ ìš°ì„ ìˆœìœ„ ê¶Œì¥ì‚¬í•­
        if high_recs:
            report += f"""
âš ï¸ ë†’ì€ ìš°ì„ ìˆœìœ„ ê¶Œì¥ì‚¬í•­:
"""
            for rec in high_recs[:3]:  # ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
                report += f"""
â€¢ {rec['title']}
   - í˜„í™©: {rec['description']}
   - ì˜ˆìƒ íš¨ê³¼: {rec['expected_improvement']}
   - ì£¼ìš” ê¶Œì¥ì‚¬í•­: {', '.join(rec['recommendations'][:2])}
"""
        
        # êµ¬í˜„ ë¡œë“œë§µ
        report += f"""
ğŸ—“ï¸ ìµœì í™” êµ¬í˜„ ë¡œë“œë§µ
{'-' * 80}

1ë‹¨ê³„ (ì¦‰ì‹œ - 1ì£¼ì¼):
"""
        
        immediate_actions = [r for r in recommendations if r['priority'] in ['critical', 'high'] and r['implementation_effort'] == 'low']
        for action in immediate_actions[:3]:
            report += f"   â€¢ {action['title']}\n"
        
        report += f"""
2ë‹¨ê³„ (1ì£¼ì¼ - 1ê°œì›”):
"""
        
        short_term_actions = [r for r in recommendations if r['priority'] == 'high' and r['implementation_effort'] == 'medium']
        for action in short_term_actions[:3]:
            report += f"   â€¢ {action['title']}\n"
        
        report += f"""
3ë‹¨ê³„ (1ê°œì›” - 3ê°œì›”):
"""
        
        long_term_actions = [r for r in recommendations if r['implementation_effort'] == 'high']
        for action in long_term_actions[:3]:
            report += f"   â€¢ {action['title']}\n"
        
        # ì„±ëŠ¥ ëª©í‘œ ë° KPI
        report += f"""
ğŸ¯ ì„±ëŠ¥ ëª©í‘œ ë° KPI
{'-' * 80}

ë‹¨ê¸° ëª©í‘œ (1ê°œì›” ë‚´):
â€¢ CPU ì‚¬ìš©ë¥ : í˜„ì¬ {resource_usage.get('cpu_percent', 0):.1f}% â†’ ëª©í‘œ 60% ì´í•˜
â€¢ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : í˜„ì¬ {resource_usage.get('memory_percent', 0):.1f}% â†’ ëª©í‘œ 50% ì´í•˜
â€¢ í”„ë¡œì„¸ìŠ¤ ì‘ë‹µì‹œê°„: ëª©í‘œ 3ì´ˆ ì´ë‚´ ìœ ì§€
â€¢ ì‹œìŠ¤í…œ ê°€ìš©ì„±: ëª©í‘œ 99% ì´ìƒ

ì¤‘ê¸° ëª©í‘œ (3ê°œì›” ë‚´):
â€¢ ìë™ ë³µêµ¬ ì„±ê³µë¥ : ëª©í‘œ 95% ì´ìƒ
â€¢ ì‹œìŠ¤í…œ ì‹œì‘ ì‹œê°„: ëª©í‘œ 20ì´ˆ ì´ë‚´
â€¢ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ëª©í‘œ 30% ê°ì†Œ
â€¢ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ìˆ˜: ëª©í‘œ 20% ê°ì†Œ

ì¥ê¸° ëª©í‘œ (6ê°œì›” ë‚´):
â€¢ ì „ì²´ ì‹œìŠ¤í…œ ì„±ëŠ¥: v1 ëŒ€ë¹„ 30% í–¥ìƒ
â€¢ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±: 40% í–¥ìƒ
â€¢ ìš´ì˜ ë¹„ìš©: 25% ì ˆê°
â€¢ ì‚¬ìš©ì ë§Œì¡±ë„: 90% ì´ìƒ
"""
        
        # ëª¨ë‹ˆí„°ë§ ë° ì¸¡ì • ê³„íš
        report += f"""
ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ì¸¡ì • ê³„íš
{'-' * 80}

ì¼ì¼ ëª¨ë‹ˆí„°ë§:
â€¢ CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ì¶”ì´
â€¢ í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ë° ì‘ë‹µì‹œê°„
â€¢ ì˜¤ë¥˜ ë°œìƒ ë¹ˆë„ ë° ë³µêµ¬ ì„±ê³µë¥ 
â€¢ ì‹œìŠ¤í…œ ë¡œê·¸ ë¶„ì„

ì£¼ê°„ ë¦¬ë·°:
â€¢ ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„
â€¢ ìµœì í™” íš¨ê³¼ ì¸¡ì •
â€¢ ìƒˆë¡œìš´ ì´ìŠˆ ì‹ë³„
â€¢ ê¶Œì¥ì‚¬í•­ ì´í–‰ ìƒí™© ì ê²€

ì›”ê°„ í‰ê°€:
â€¢ KPI ë‹¬ì„±ë„ í‰ê°€
â€¢ ìµœì í™” ROI ë¶„ì„
â€¢ ë‹¤ìŒ ë‹¨ê³„ ê³„íš ìˆ˜ë¦½
â€¢ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œì„  ê²€í† 
"""
        
        # ê²°ë¡  ë° ë‹¤ìŒ ë‹¨ê³„
        overall_assessment = comparison.get('overall_assessment', 'unknown')
        
        if overall_assessment == 'significant_improvement':
            conclusion = "âœ… v2 ì‹œìŠ¤í…œì´ v1 ëŒ€ë¹„ ìƒë‹¹í•œ ì„±ëŠ¥ í–¥ìƒì„ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤."
        elif overall_assessment == 'moderate_improvement':
            conclusion = "ğŸ“ˆ v2 ì‹œìŠ¤í…œì´ v1 ëŒ€ë¹„ ì ë‹¹í•œ ì„±ëŠ¥ í–¥ìƒì„ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤."
        elif overall_assessment == 'mixed_results':
            conclusion = "ğŸ“Š v2 ì‹œìŠ¤í…œì´ ì¼ë¶€ ì˜ì—­ì—ì„œ ê°œì„ , ì¼ë¶€ ì˜ì—­ì—ì„œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
        else:
            conclusion = "âš ï¸ v2 ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ ìµœì í™”ê°€ ë” í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤."
        
        report += f"""
ğŸ¯ ê²°ë¡  ë° ë‹¤ìŒ ë‹¨ê³„
{'-' * 80}

{conclusion}

ì£¼ìš” ì„±ê³¼:
â€¢ ì‹œìŠ¤í…œ í†µí•© ë° v2 ì•„í‚¤í…ì²˜ êµ¬í˜„ ì™„ë£Œ
â€¢ ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ ëŒ€í­ ê°œì„ 
â€¢ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ ê°•í™”
â€¢ ì œì–´ì„¼í„° ê¸°ëŠ¥ ì™„ì „ êµ¬í˜„

ë‹¤ìŒ ë‹¨ê³„:
1. ê¸´ê¸‰ ìµœì í™” í•­ëª© ì¦‰ì‹œ ì ìš©
2. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê°•í™”
3. ì •ê¸°ì ì¸ ì„±ëŠ¥ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤ êµ¬ì¶•
4. ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ë°˜ì˜
5. ì§€ì†ì ì¸ ì‹œìŠ¤í…œ ê°œì„  ë° ìµœì í™”

ğŸ“ ì§€ì› ë° ë¬¸ì˜:
â€¢ ê¸°ìˆ  ì§€ì›: POSCO WatchHamster v3.0 ê°œë°œíŒ€
â€¢ ì„±ëŠ¥ ìµœì í™” ë¬¸ì˜: ì‹œìŠ¤í…œ ì•„í‚¤í…íŠ¸
â€¢ ê¸´ê¸‰ ìƒí™©: 24/7 ëª¨ë‹ˆí„°ë§ ì„¼í„°

ë³´ê³ ì„œ ìƒì„±: {report_time.strftime('%Y-%m-%d %H:%M:%S')}
ë³´ê³ ì„œ ë²„ì „: v2.0-optimization-final
"""
        
        return report  
  
    def run_optimization_analysis(self) -> bool:
        """ìµœì í™” ë¶„ì„ ì‹¤í–‰"""
        print("ğŸš€ POSCO WatchHamster v3.0 ì‹œìŠ¤í…œ ìµœì í™” ë¶„ì„ ì‹œì‘")
        print("=" * 60)
        
        try:
            # 1. ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
            print("\nğŸ“Š 1ë‹¨ê³„: ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘")
            self.report_data['system_metrics'] = self.collect_system_metrics()
            
            # 2. ì„±ëŠ¥ ë°ì´í„° ë¶„ì„
            print("\nğŸ“ˆ 2ë‹¨ê³„: ì„±ëŠ¥ ë°ì´í„° ë¶„ì„")
            self.report_data['performance_analysis'] = self.analyze_performance_data()
            
            # 3. ìµœì í™” ê¶Œì¥ì‚¬í•­ ìƒì„±
            print("\nğŸ’¡ 3ë‹¨ê³„: ìµœì í™” ê¶Œì¥ì‚¬í•­ ìƒì„±")
            self.report_data['optimization_recommendations'] = self.generate_optimization_recommendations()
            
            # 4. v1/v2 ì„±ëŠ¥ ë¹„êµ
            print("\nğŸ“Š 4ë‹¨ê³„: v1/v2 ì„±ëŠ¥ ë¹„êµ")
            self.report_data['performance_comparison'] = self.generate_performance_comparison()
            
            # 5. ìµœì¢… ë³´ê³ ì„œ ìƒì„±
            print("\nğŸ“„ 5ë‹¨ê³„: ìµœì¢… ë³´ê³ ì„œ ìƒì„±")
            final_report = self.generate_final_optimization_report()
            
            # 6. ë³´ê³ ì„œ ì €ì¥
            report_file = os.path.join(self.script_dir, 'system_optimization_report.md')
            with open(report_file, 'w', encoding='utf-8') as f:
                f.write(final_report)
            
            # JSON ë°ì´í„°ë„ ì €ì¥
            json_file = os.path.join(self.script_dir, 'system_optimization_data.json')
            with open(json_file, 'w', encoding='utf-8') as f:
                json.dump(self.report_data, f, indent=2, ensure_ascii=False, default=str)
            
            print(f"\nâœ… ìµœì í™” ë¶„ì„ ì™„ë£Œ!")
            print(f"ğŸ“„ ë³´ê³ ì„œ ì €ì¥ë¨: {os.path.basename(report_file)}")
            print(f"ğŸ“Š ë°ì´í„° ì €ì¥ë¨: {os.path.basename(json_file)}")
            
            # ë³´ê³ ì„œ ìš”ì•½ ì¶œë ¥
            print("\n" + "=" * 60)
            print("ğŸ“‹ ë¶„ì„ ê²°ê³¼ ìš”ì•½")
            print("=" * 60)
            
            metrics = self.report_data['system_metrics']
            analysis = self.report_data['performance_analysis']
            recommendations = self.report_data['optimization_recommendations']
            comparison = self.report_data['performance_comparison']
            
            print(f"ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ:")
            resource_usage = metrics.get('resource_usage', {})
            print(f"  â€¢ CPU ì‚¬ìš©ë¥ : {resource_usage.get('cpu_percent', 0):.1f}%")
            print(f"  â€¢ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {resource_usage.get('memory_percent', 0):.1f}%")
            print(f"  â€¢ í™œì„± í”„ë¡œì„¸ìŠ¤: {metrics.get('process_info', {}).get('active_watchhamster_processes', 0)}ê°œ")
            
            print(f"\nğŸ“Š ë¶„ì„ ê²°ê³¼:")
            print(f"  â€¢ ì„±ëŠ¥ ì´ìŠˆ: {len(analysis.get('performance_issues', []))}ê°œ")
            print(f"  â€¢ ìµœì í™” ê¸°íšŒ: {len(analysis.get('optimization_opportunities', []))}ê°œ")
            print(f"  â€¢ ìµœì í™” ê¶Œì¥ì‚¬í•­: {len(recommendations)}ê°œ")
            
            print(f"\nğŸ“ˆ v1/v2 ë¹„êµ:")
            print(f"  â€¢ ê°œì„ ëœ ì˜ì—­: {len(comparison.get('improvements', []))}ê°œ")
            print(f"  â€¢ ì£¼ì˜ í•„ìš” ì˜ì—­: {len(comparison.get('regressions', []))}ê°œ")
            print(f"  â€¢ ì „ì²´ í‰ê°€: {comparison.get('overall_assessment', 'unknown')}")
            
            # ê¸´ê¸‰ ê¶Œì¥ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° ê°•ì¡°
            critical_recs = [r for r in recommendations if r.get('priority') == 'critical']
            if critical_recs:
                print(f"\nğŸš¨ ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”:")
                for rec in critical_recs[:2]:  # ìµœëŒ€ 2ê°œë§Œ í‘œì‹œ
                    print(f"  â€¢ {rec['title']}")
            
            return True
            
        except Exception as e:
            print(f"\nâŒ ìµœì í™” ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜: {e}")
            import traceback
            traceback.print_exc()
            return False


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    generator = SystemOptimizationReportGenerator()
    
    try:
        success = generator.run_optimization_analysis()
        return 0 if success else 1
        
    except KeyboardInterrupt:
        print("\nâš ï¸ ë¶„ì„ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return 1
        
    except Exception as e:
        print(f"âŒ ë¶„ì„ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == '__main__':
    sys.exit(main())