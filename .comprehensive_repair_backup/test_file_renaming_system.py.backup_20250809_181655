#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Test File Renaming System
POSCO ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import os
import tempfile
import shutil
from pathlib import Path
import unittest
from file_renaming_system import FileRenamingSystem, ComponentType, MappingEntry
from naming_convention_manager import NamingConventionManager


class TestFileRenamingSystem(unittest.TestCase):
    """íŒŒì¼ ë¦¬ë„¤ì´ë° ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤"""
    
    def setUp(self):
        """í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •"""
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        self.test_dir = Path(tempfile.mkdtemp())
        self.renaming_system = FileRenamingSystem(str(self.test_dir))
        
        # í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ ë° í´ë” ìƒì„±
        self.create_test_files()
    
    def tearDown(self):
        """í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬"""
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì‚­ì œ
        shutil.rmtree(self.test_dir)
    
    def create_test_files(self):
        """í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ ë° í´ë” ìƒì„±"""
        # ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ íŒŒì¼ë“¤
        watchhamster_files = [
            "ğŸ¹WatchHamster v3.0.bat",
            "demo_v2_integration.py",
            "test_v2_integration.py",
            "monitor_WatchHamster.py"
        ]
        
        # POSCO News 250808 ê´€ë ¨ íŒŒì¼ë“¤
        POSCO News 250808_files = [
            "POSCO News 250808_mini.py",
            "posco_main_notifier.py",
            "posco_continuous_monitor.py",
            "POSCO News 250808_data.json"
        ]
        
        # ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ í´ë”ë“¤
        watchhamster_folders = [
            "WatchHamster_v3.0",
            "watchhamster-v3.0-integration"
        ]
        
        # POSCO News 250808 ê´€ë ¨ í´ë”ë“¤
        POSCO News 250808_folders = [
            "POSCO News 250808_mini"
        ]
        
        # íŒŒì¼ ìƒì„±
        for filename in watchhamster_files + POSCO News 250808_files:
            file_path = self.test_dir / filename
            file_path.write_text(f"# Test content for {filename}\n", encoding='utf-8')
        
        # í´ë” ìƒì„±
        for foldername in watchhamster_folders + POSCO News 250808_folders:
            folder_path = self.test_dir / foldername
            folder_path.mkdir(exist_ok=True)
            # í´ë” ì•ˆì— í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
            (folder_path / "test_file.txt").write_text("test content", encoding='utf-8')
    
    def test_analyze_existing_files(self):
        """ê¸°ì¡´ íŒŒì¼ ë¶„ì„ í…ŒìŠ¤íŠ¸"""
        mapping_by_component = self.renaming_system.analyze_existing_files()
        
        # ì›Œì¹˜í–„ìŠ¤í„° ê´€ë ¨ ë§¤í•‘ì´ ìˆëŠ”ì§€ í™•ì¸
        self.assertGreater(len(mapping_by_component[ComponentType.WATCHHAMSTER]), 0)
        
        # POSCO News 250808 ê´€ë ¨ ë§¤í•‘ì´ ìˆëŠ”ì§€ í™•ì¸
        self.assertGreater(len(mapping_by_component[ComponentType.POSCO News 250808]), 0)
        
        # ë§¤í•‘ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        self.assertGreater(len(self.renaming_system.mapping_table), 0)
        
        print(f"ë¶„ì„ëœ ë§¤í•‘ ìˆ˜: {len(self.renaming_system.mapping_table)}")
        for entry in self.renaming_system.mapping_table[:5]:  # ì²˜ìŒ 5ê°œë§Œ ì¶œë ¥
            print(f"  {entry.original_path} â†’ {entry.new_path} ({entry.component.value})")
    
    def test_rename_watchhamster_files_dry_run(self):
        """ì›Œì¹˜í–„ìŠ¤í„° íŒŒì¼ ì´ë¦„ ë³€ê²½ ë“œë¼ì´ ëŸ° í…ŒìŠ¤íŠ¸"""
        # ë¨¼ì € íŒŒì¼ ë¶„ì„
        self.renaming_system.analyze_existing_files()
        
        # ë“œë¼ì´ ëŸ° ì‹¤í–‰
        operations = self.renaming_system.rename_watchhamster_files(dry_run=True)
        
        # ì‘ì—…ì´ ìˆ˜í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
        self.assertGreater(len(operations), 0)
        
        # ëª¨ë“  ì‘ì—…ì´ ì„±ê³µìœ¼ë¡œ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë“œë¼ì´ ëŸ°ì´ë¯€ë¡œ)
        for operation in operations:
            self.assertTrue(operation.success)
        
        print(f"ì›Œì¹˜í–„ìŠ¤í„° ë“œë¼ì´ ëŸ° ì‘ì—… ìˆ˜: {len(operations)}")
        for operation in operations[:3]:  # ì²˜ìŒ 3ê°œë§Œ ì¶œë ¥
            print(f"  {operation.source_path} â†’ {operation.target_path}")
    
    def test_rename_POSCO News 250808_files_dry_run(self):
        """POSCO News 250808 íŒŒì¼ ì´ë¦„ ë³€ê²½ ë“œë¼ì´ ëŸ° í…ŒìŠ¤íŠ¸"""
        # ë¨¼ì € íŒŒì¼ ë¶„ì„
        self.renaming_system.analyze_existing_files()
        
        # ë“œë¼ì´ ëŸ° ì‹¤í–‰
        operations = self.renaming_system.rename_POSCO News 250808_files(dry_run=True)
        
        # ì‘ì—…ì´ ìˆ˜í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
        self.assertGreater(len(operations), 0)
        
        # ëª¨ë“  ì‘ì—…ì´ ì„±ê³µìœ¼ë¡œ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë“œë¼ì´ ëŸ°ì´ë¯€ë¡œ)
        for operation in operations:
            self.assertTrue(operation.success)
        
        print(f"POSCO News 250808 ë“œë¼ì´ ëŸ° ì‘ì—… ìˆ˜: {len(operations)}")
        for operation in operations[:3]:  # ì²˜ìŒ 3ê°œë§Œ ì¶œë ¥
            print(f"  {operation.source_path} â†’ {operation.target_path}")
    
    def test_actual_file_renaming(self):
        """ì‹¤ì œ íŒŒì¼ ì´ë¦„ ë³€ê²½ í…ŒìŠ¤íŠ¸"""
        # ë¨¼ì € íŒŒì¼ ë¶„ì„
        self.renaming_system.analyze_existing_files()
        
        # ë³€ê²½ ì „ íŒŒì¼ ëª©ë¡ ì €ì¥
        original_files = list(self.test_dir.glob("*"))
        
        # ì›Œì¹˜í–„ìŠ¤í„° íŒŒì¼ ì´ë¦„ ë³€ê²½
        wh_operations = self.renaming_system.rename_watchhamster_files(dry_run=False)
        
        # POSCO News 250808 íŒŒì¼ ì´ë¦„ ë³€ê²½
        pn_operations = self.renaming_system.rename_POSCO News 250808_files(dry_run=False)
        
        # ë³€ê²½ í›„ íŒŒì¼ ëª©ë¡
        new_files = list(self.test_dir.glob("*"))
        
        print(f"ì‹¤ì œ ë³€ê²½ ì‘ì—… ìˆ˜: {len(wh_operations + pn_operations)}")
        print(f"ë³€ê²½ ì „ íŒŒì¼ ìˆ˜: {len(original_files)}")
        print(f"ë³€ê²½ í›„ íŒŒì¼ ìˆ˜: {len(new_files)}")
        
        # ì„±ê³µí•œ ì‘ì—…ì´ ìˆëŠ”ì§€ í™•ì¸
        successful_operations = [op for op in wh_operations + pn_operations if op.success]
        self.assertGreater(len(successful_operations), 0)
        
        print(f"ì„±ê³µí•œ ì‘ì—… ìˆ˜: {len(successful_operations)}")
    
    def test_rollback_functionality(self):
        """ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"""
        # ë¨¼ì € íŒŒì¼ ë¶„ì„ ë° ë³€ê²½
        self.renaming_system.analyze_existing_files()
        operations = self.renaming_system.rename_watchhamster_files(dry_run=False)
        
        # ì„±ê³µí•œ ì‘ì—…ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ë¡¤ë°± í…ŒìŠ¤íŠ¸
        successful_operations = [op for op in operations if op.success]
        if successful_operations:
            # ë¡¤ë°± ì‹¤í–‰
            rollback_success = self.renaming_system.rollback_operations()
            self.assertTrue(rollback_success)
            
            print(f"ë¡¤ë°± ì™„ë£Œ: {len(successful_operations)}ê°œ ì‘ì—…")
    
    def test_mapping_table_persistence(self):
        """ë§¤í•‘ í…Œì´ë¸” ì €ì¥/ë¡œë“œ í…ŒìŠ¤íŠ¸"""
        # íŒŒì¼ ë¶„ì„
        self.renaming_system.analyze_existing_files()
        original_mapping_count = len(self.renaming_system.mapping_table)
        
        # ë§¤í•‘ í…Œì´ë¸” íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        self.assertTrue(self.renaming_system.mapping_table_file.exists())
        
        # ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¡œë“œ í…ŒìŠ¤íŠ¸
        new_system = FileRenamingSystem(str(self.test_dir))
        # ë§¤í•‘ í…Œì´ë¸”ì€ analyze_existing_filesì—ì„œ ìƒì„±ë˜ë¯€ë¡œ ë‹¤ì‹œ ë¶„ì„
        new_system.analyze_existing_files()
        
        print(f"ì›ë³¸ ë§¤í•‘ ìˆ˜: {original_mapping_count}")
        print(f"ìƒˆë¡œ ë¡œë“œëœ ë§¤í•‘ ìˆ˜: {len(new_system.mapping_table)}")
    
    def test_operations_log_persistence(self):
        """ì‘ì—… ë¡œê·¸ ì €ì¥/ë¡œë“œ í…ŒìŠ¤íŠ¸"""
        # íŒŒì¼ ë¶„ì„ ë° ì‘ì—… ìˆ˜í–‰
        self.renaming_system.analyze_existing_files()
        operations = self.renaming_system.rename_watchhamster_files(dry_run=True)
        
        # ì‘ì—… ë¡œê·¸ ì €ì¥
        self.renaming_system._save_operations_log()
        
        # ì‘ì—… ë¡œê·¸ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        self.assertTrue(self.renaming_system.operations_log_file.exists())
        
        # ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¡œë“œ í…ŒìŠ¤íŠ¸
        new_system = FileRenamingSystem(str(self.test_dir))
        load_success = new_system.load_previous_operations()
        
        if load_success:
            self.assertEqual(len(new_system.operations_log), len(operations))
            print(f"ë¡œë“œëœ ì‘ì—… ë¡œê·¸ ìˆ˜: {len(new_system.operations_log)}")
    
    def test_generate_reports(self):
        """ë³´ê³ ì„œ ìƒì„± í…ŒìŠ¤íŠ¸"""
        # íŒŒì¼ ë¶„ì„ ë° ì‘ì—… ìˆ˜í–‰
        self.renaming_system.analyze_existing_files()
        self.renaming_system.rename_watchhamster_files(dry_run=True)
        
        # ì‘ì—… ë³´ê³ ì„œ ìƒì„±
        operations_report = self.renaming_system.generate_operations_report()
        self.assertIsInstance(operations_report, str)
        self.assertGreater(len(operations_report), 0)
        
        # ë§¤í•‘ ìš”ì•½ ìƒì„±
        mapping_summary = self.renaming_system.get_mapping_summary()
        self.assertIsInstance(mapping_summary, dict)
        self.assertIn("total_mappings", mapping_summary)
        
        print("ì‘ì—… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ")
        print(f"ë§¤í•‘ ìš”ì•½: {mapping_summary}")


def run_integration_test():
    """í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
    print("POSCO íŒŒì¼ ë¦¬ë„¤ì´ë° ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    # ì‹¤ì œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ í…ŒìŠ¤íŠ¸ (ë“œë¼ì´ ëŸ°ë§Œ)
    real_system = FileRenamingSystem(".")
    
    print("\n1. ì‹¤ì œ íŒŒì¼ ë¶„ì„ ì¤‘...")
    mapping_by_component = real_system.analyze_existing_files()
    
    summary = real_system.get_mapping_summary()
    print(f"\nì‹¤ì œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¶„ì„ ê²°ê³¼:")
    for key, value in summary.items():
        print(f"  {key}: {value}")
    
    print(f"\n2. ì›Œì¹˜í–„ìŠ¤í„° íŒŒì¼ ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜...")
    wh_operations = real_system.rename_watchhamster_files(dry_run=True)
    print(f"ì›Œì¹˜í–„ìŠ¤í„° ë³€ê²½ ì˜ˆì •: {len(wh_operations)}ê°œ")
    
    print(f"\n3. POSCO News 250808 íŒŒì¼ ë³€ê²½ ì‹œë®¬ë ˆì´ì…˜...")
    pn_operations = real_system.rename_POSCO News 250808_files(dry_run=True)
    print(f"POSCO News 250808 ë³€ê²½ ì˜ˆì •: {len(pn_operations)}ê°œ")
    
    # ë³€ê²½ ì˜ˆì • íŒŒì¼ë“¤ ì¶œë ¥ (ì²˜ìŒ 10ê°œë§Œ)
    all_operations = wh_operations + pn_operations
    successful_ops = [op for op in all_operations if op.success]
    
    print(f"\n4. ë³€ê²½ ì˜ˆì • íŒŒì¼ë“¤ (ì²˜ìŒ 10ê°œ):")
    for i, operation in enumerate(successful_ops[:10]):
        source_name = Path(operation.source_path).name
        target_name = Path(operation.target_path).name
        print(f"  {i+1}. {source_name} â†’ {target_name}")
    
    if len(successful_ops) > 10:
        print(f"  ... ì™¸ {len(successful_ops) - 10}ê°œ ë”")
    
    # ë³´ê³ ì„œ ìƒì„±
    report = real_system.generate_operations_report()
    report_file = Path("file_renaming_simulation_report.txt")
    with open(report_file, 'w', encoding='utf-8') as f:
        f.write(report)
    
    print(f"\n5. ì‹œë®¬ë ˆì´ì…˜ ë³´ê³ ì„œ ì €ì¥: {report_file}")
    print("\ní†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")


if __name__ == "__main__":
    # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    print("ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...")
    unittest.main(argv=[''], exit=False, verbosity=2)
    
    print("\n" + "="*50)
    
    # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    run_integration_test()