#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Migration Status Reporter
POSCO ì‹œìŠ¤í…œ êµ¬ì„±ìš”ì†Œ

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import os
import sys
import json
import time
import logging
import sqlite3
from pathlib import Path
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Tuple
from dataclasses import dataclass, asdict
import hashlib
import subprocess

@dataclass
class MigrationEvent:
    """ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë²¤íŠ¸"""
    id: str
    timestamp: str
    event_type: str  # 'start', 'progress', 'success', 'warning', 'error', 'complete'
    phase: str  # 'pre_check', 'backup', 'migration', 'verification', 'rollback'
    message: str
    details: Dict[str, Any]
    duration: Optional[float] = None
    user: Optional[str] = None
    system_info: Optional[Dict[str, str]] = None

@dataclass
class SystemSnapshot:
    """ì‹œìŠ¤í…œ ìŠ¤ëƒ…ìƒ·"""
    timestamp: str
    cpu_usage: float
    memory_usage: float
    disk_usage: float
    process_count: int
    active_processes: List[str]
    file_checksums: Dict[str, str]

class MigrationStatusReporter:
    """ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œ"""
    
    def __init__(self):
        self.script_dir = Path(__file__).parent.absolute()
        self.db_path = self.script_dir / "migration_history.db"
        self.log_dir = self.script_dir / "migration_logs"
        self.reports_dir = self.script_dir / "migration_reports"
        
        # ë””ë ‰í† ë¦¬ ìƒì„±
        self.log_dir.mkdir(exist_ok=True)
        self.reports_dir.mkdir(exist_ok=True)
        
        # ë¡œê¹… ì„¤ì •
        self.log_file = self.log_dir / f"migration_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"
        self._setup_logging()
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
        self._init_database()
        
        # í˜„ì¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜
        self.session_id = self._generate_session_id()
        self.session_start = datetime.now()
        
        # ìƒ‰ìƒ ì •ì˜
        self.colors = {
            'RED': '\033[0;31m',
            'GREEN': '\033[0;32m',
            'YELLOW': '\033[1;33m',
            'BLUE': '\033[0;34m',
            'PURPLE': '\033[0;35m',
            'CYAN': '\033[0;36m',
            'NC': '\033[0m'
        }
        
        self.logger.info(f"ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ (ì„¸ì…˜: {self.session_id})")
    
    def _setup_logging(self):
        """ë¡œê¹… ì‹œìŠ¤í…œ ì„¤ì •"""
        # íŒŒì¼ í•¸ë“¤ëŸ¬
        file_handler = logging.FileHandler(self.log_file, encoding='utf-8')
        file_handler.setLevel(logging.DEBUG)
        
        # ì½˜ì†” í•¸ë“¤ëŸ¬
        console_handler = logging.StreamHandler(sys.stdout)
        console_handler.setLevel(logging.INFO)
        
        # í¬ë§·í„°
        formatter = logging.Formatter(
            '%(asctime)s - %(levelname)s - [%(name)s] - %(message)s'
        )
        file_handler.setFormatter(formatter)
        console_handler.setFormatter(formatter)
        
        # ë¡œê±° ì„¤ì •
        self.logger = logging.getLogger('MigrationReporter')
        self.logger.setLevel(logging.DEBUG)
        self.logger.addHandler(file_handler)
        self.logger.addHandler(console_handler)
    
    def _init_database(self):
        """ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë²¤íŠ¸ í…Œì´ë¸”
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS migration_events (
                    id TEXT PRIMARY KEY,
                    session_id TEXT,
                    timestamp TEXT,
                    event_type TEXT,
                    phase TEXT,
                    message TEXT,
                    details TEXT,
                    duration REAL,
                    user TEXT,
                    system_info TEXT
                )
            ''')
            
            # ì‹œìŠ¤í…œ ìŠ¤ëƒ…ìƒ· í…Œì´ë¸”
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS system_snapshots (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    session_id TEXT,
                    timestamp TEXT,
                    cpu_usage REAL,
                    memory_usage REAL,
                    disk_usage REAL,
                    process_count INTEGER,
                    active_processes TEXT,
                    file_checksums TEXT
                )
            ''')
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜ í…Œì´ë¸”
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS migration_sessions (
                    session_id TEXT PRIMARY KEY,
                    start_time TEXT,
                    end_time TEXT,
                    status TEXT,
                    total_events INTEGER,
                    success_count INTEGER,
                    error_count INTEGER,
                    warning_count INTEGER
                )
            ''')
            
            conn.commit()
    
    def _generate_session_id(self) -> str:
        """ì„¸ì…˜ ID ìƒì„±"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        hash_input = f"{timestamp}_{os.getpid()}_{time.time()}"
        hash_suffix = hashlib.md5(hash_input.encode()).hexdigest()[:8]
        return f"migration_{timestamp}_{hash_suffix}"
    
    def _print_colored(self, message: str, color: str = 'NC'):
        """ìƒ‰ìƒì´ ìˆëŠ” ë©”ì‹œì§€ ì¶œë ¥"""
        print(f"{self.colors[color]}{message}{self.colors['NC']}")
    
    def log_event(self, event_type: str, phase: str, message: str, 
                  details: Dict[str, Any] = None, duration: float = None):
        """ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë²¤íŠ¸ ë¡œê¹…"""
        event_id = f"{self.session_id}_{int(time.time() * 1000)}"
        
        # ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
        system_info = self._collect_system_info()
        
        # ì´ë²¤íŠ¸ ìƒì„±
        event = MigrationEvent(
            id=event_id,
            timestamp=datetime.now().isoformat(),
            event_type=event_type,
            phase=phase,
            message=message,
            details=details or {},
            duration=duration,
            user=os.getenv('USER', 'unknown'),
            system_info=system_info
        )
        
        # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO migration_events 
                (id, session_id, timestamp, event_type, phase, message, details, duration, user, system_info)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                event.id, self.session_id, event.timestamp, event.event_type,
                event.phase, event.message, json.dumps(event.details, ensure_ascii=False),
                event.duration, event.user, json.dumps(event.system_info, ensure_ascii=False)
            ))
            conn.commit()
        
        # ë¡œê·¸ ì¶œë ¥
        level = logging.ERROR if event_type == 'error' else logging.WARNING if event_type == 'warning' else logging.INFO
        self.logger.log(level, f"[{phase}] {message}")
        
        # ì½˜ì†” ì¶œë ¥ (ìƒ‰ìƒ í¬í•¨)
        color = 'RED' if event_type == 'error' else 'YELLOW' if event_type == 'warning' else 'GREEN' if event_type == 'success' else 'BLUE'
        icon = 'âŒ' if event_type == 'error' else 'âš ï¸' if event_type == 'warning' else 'âœ…' if event_type == 'success' else 'ğŸ“‹'
        
        self._print_colored(f"{icon} [{phase}] {message}", color)
        
        if details:
            for key, value in details.items():
                self._print_colored(f"    {key}: {value}", 'CYAN')
    
    def _collect_system_info(self) -> Dict[str, str]:
        """ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘"""
        try:
            import psutil
            
            return {
                'cpu_percent': str(psutil.cpu_percent()),
                'memory_percent': str(psutil.virtual_memory().percent),
                'disk_percent': str(psutil.disk_usage('/').percent),
                'process_count': str(len(psutil.pids())),
                'python_version': sys.version.split()[0],
                'platform': sys.platform
            }
        except ImportError:
            # psutilì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì •ë³´ë§Œ
            return {
                'python_version': sys.version.split()[0],
                'platform': sys.platform,
                'pid': str(os.getpid())
            }
    
    def take_system_snapshot(self) -> SystemSnapshot:
        """ì‹œìŠ¤í…œ ìŠ¤ëƒ…ìƒ· ìƒì„±"""
        try:
            import psutil
            
            # í™œì„± í”„ë¡œì„¸ìŠ¤ ëª©ë¡
            active_processes = []
            for proc in psutil.process_iter(['pid', 'name']):
                try:
                    if 'python' in proc.info['name'].lower() or 'watchhamster' in proc.info['name'].lower():
                        active_processes.append(f"{proc.info['name']}({proc.info['pid']})")
                except (psutil.NoSuchProcess, psutil.AccessDenied):
                    continue
            
            # ì£¼ìš” íŒŒì¼ ì²´í¬ì„¬
            file_checksums = self._calculate_file_checksums()
            
            snapshot = SystemSnapshot(
                timestamp=datetime.now().isoformat(),
                cpu_usage=psutil.cpu_percent(),
                memory_usage=psutil.virtual_memory().percent,
                disk_usage=psutil.disk_usage('/').percent,
                process_count=len(psutil.pids()),
                active_processes=active_processes,
                file_checksums=file_checksums
            )
            
            # ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO system_snapshots 
                    (session_id, timestamp, cpu_usage, memory_usage, disk_usage, 
                     process_count, active_processes, file_checksums)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    self.session_id, snapshot.timestamp, snapshot.cpu_usage,
                    snapshot.memory_usage, snapshot.disk_usage, snapshot.process_count,
                    json.dumps(snapshot.active_processes, ensure_ascii=False),
                    json.dumps(snapshot.file_checksums, ensure_ascii=False)
                ))
                conn.commit()
            
            return snapshot
            
        except ImportError:
            # psutilì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ìŠ¤ëƒ…ìƒ·
            return SystemSnapshot(
                timestamp=datetime.now().isoformat(),
                cpu_usage=0.0,
                memory_usage=0.0,
                disk_usage=0.0,
                process_count=0,
                active_processes=[],
                file_checksums=self._calculate_file_checksums()
            )
    
    def _calculate_file_checksums(self) -> Dict[str, str]:
        """ì£¼ìš” íŒŒì¼ë“¤ì˜ ì²´í¬ì„¬ ê³„ì‚°"""
        important_files = [
            "Monitoring/POSCO News 250808_mini/monitor_WatchHamster.py",
            "watchhamster_control_center.sh",
            "Monitoring/WatchHamster_v3.0/modules.json"
        ]
        
        checksums = {}
        
        for file_path in important_files:
            full_path = self.script_dir / file_path
            if full_path.exists():
                try:
                    with open(full_path, 'rb') as f:
                        content = f.read()
                        checksums[file_path] = hashlib.md5(content).hexdigest()
                except Exception as e:
                    checksums[file_path] = f"error: {str(e)}"
            else:
                checksums[file_path] = "not_found"
        
        return checksums
    
    def start_migration_phase(self, phase: str, description: str):
        """ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ ì‹œì‘"""
        self.log_event('start', phase, f"{description} ì‹œì‘")
        self.take_system_snapshot()
    
    def complete_migration_phase(self, phase: str, description: str, duration: float, success: bool = True):
        """ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ ì™„ë£Œ"""
        event_type = 'success' if success else 'error'
        self.log_event(event_type, phase, f"{description} {'ì™„ë£Œ' if success else 'ì‹¤íŒ¨'}", 
                      {'duration_seconds': duration}, duration)
        self.take_system_snapshot()
    
    def log_progress(self, phase: str, message: str, progress_percent: int = None):
        """ì§„í–‰ ìƒí™© ë¡œê¹…"""
        details = {}
        if progress_percent is not None:
            details['progress_percent'] = progress_percent
        
        self.log_event('progress', phase, message, details)
    
    def log_warning(self, phase: str, message: str, details: Dict[str, Any] = None):
        """ê²½ê³  ë¡œê¹…"""
        self.log_event('warning', phase, message, details)
    
    def log_error(self, phase: str, message: str, error: Exception = None, details: Dict[str, Any] = None):
        """ì˜¤ë¥˜ ë¡œê¹…"""
        error_details = details or {}
        if error:
            error_details['exception_type'] = type(error).__name__
            error_details['exception_message'] = str(error)
        
        self.log_event('error', phase, message, error_details)
    
    def generate_migration_report(self, session_id: str = None) -> str:
        """ë§ˆì´ê·¸ë ˆì´ì…˜ ë³´ê³ ì„œ ìƒì„±"""
        target_session = session_id or self.session_id
        
        self._print_colored("ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ë³´ê³ ì„œ ìƒì„± ì¤‘...", 'BLUE')
        
        # ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì´ë²¤íŠ¸ ì¡°íšŒ
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # ì´ë²¤íŠ¸ ì¡°íšŒ
            cursor.execute('''
                SELECT * FROM migration_events 
                WHERE session_id = ? 
                ORDER BY timestamp
            ''', (target_session,))
            events = cursor.fetchall()
            
            # ìŠ¤ëƒ…ìƒ· ì¡°íšŒ
            cursor.execute('''
                SELECT * FROM system_snapshots 
                WHERE session_id = ? 
                ORDER BY timestamp
            ''', (target_session,))
            snapshots = cursor.fetchall()
        
        if not events:
            return "ì§€ì •ëœ ì„¸ì…˜ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        
        # ë³´ê³ ì„œ ìƒì„±
        report_lines = []
        report_lines.append("=" * 80)
        report_lines.append("POSCO WatchHamster v3.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ë³´ê³ ì„œ")
        report_lines.append("=" * 80)
        report_lines.append(f"ì„¸ì…˜ ID: {target_session}")
        report_lines.append(f"ë³´ê³ ì„œ ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        report_lines.append("")
        
        # ìš”ì•½ ì •ë³´
        event_types = {}
        phases = {}
        total_duration = 0
        
        for event in events:
            event_type = event[3]  # event_type
            phase = event[4]       # phase
            duration = event[7]    # duration
            
            event_types[event_type] = event_types.get(event_type, 0) + 1
            phases[phase] = phases.get(phase, 0) + 1
            
            if duration:
                total_duration += duration
        
        report_lines.append("ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìš”ì•½")
        report_lines.append("-" * 40)
        report_lines.append(f"ì´ ì´ë²¤íŠ¸ ìˆ˜: {len(events)}ê°œ")
        report_lines.append(f"ì´ ì†Œìš” ì‹œê°„: {total_duration:.2f}ì´ˆ")
        report_lines.append("")
        
        report_lines.append("ì´ë²¤íŠ¸ ìœ í˜•ë³„ í†µê³„:")
        for event_type, count in event_types.items():
            icon = "âœ…" if event_type == "success" else "âŒ" if event_type == "error" else "âš ï¸" if event_type == "warning" else "ğŸ“‹"
            report_lines.append(f"  {icon} {event_type}: {count}ê°œ")
        report_lines.append("")
        
        report_lines.append("ë‹¨ê³„ë³„ í†µê³„:")
        for phase, count in phases.items():
            report_lines.append(f"  ğŸ“‹ {phase}: {count}ê°œ ì´ë²¤íŠ¸")
        report_lines.append("")
        
        # ìƒì„¸ ì´ë²¤íŠ¸ ë¡œê·¸
        report_lines.append("ğŸ“‹ ìƒì„¸ ì´ë²¤íŠ¸ ë¡œê·¸")
        report_lines.append("-" * 40)
        
        for event in events:
            timestamp = datetime.fromisoformat(event[2]).strftime('%H:%M:%S')
            event_type = event[3]
            phase = event[4]
            message = event[5]
            duration = event[7]
            
            icon = "âœ…" if event_type == "success" else "âŒ" if event_type == "error" else "âš ï¸" if event_type == "warning" else "ğŸ“‹"
            
            duration_str = f" ({duration:.2f}s)" if duration else ""
            report_lines.append(f"{timestamp} {icon} [{phase}] {message}{duration_str}")
            
            # ìƒì„¸ ì •ë³´ í‘œì‹œ
            if event[6]:  # details
                try:
                    details = json.loads(event[6])
                    for key, value in details.items():
                        if key != 'duration_seconds':  # ì´ë¯¸ í‘œì‹œë¨
                            report_lines.append(f"    {key}: {value}")
                except json.JSONDecodeError:
                    pass
        
        report_lines.append("")
        
        # ì‹œìŠ¤í…œ ìŠ¤ëƒ…ìƒ· ì •ë³´
        if snapshots:
            report_lines.append("ğŸ“Š ì‹œìŠ¤í…œ ì„±ëŠ¥ ì¶”ì´")
            report_lines.append("-" * 40)
            
            for i, snapshot in enumerate(snapshots):
                timestamp = datetime.fromisoformat(snapshot[2]).strftime('%H:%M:%S')
                cpu = snapshot[3]
                memory = snapshot[4]
                disk = snapshot[5]
                processes = snapshot[6]
                
                report_lines.append(f"{timestamp} - CPU: {cpu:.1f}%, ë©”ëª¨ë¦¬: {memory:.1f}%, ë””ìŠ¤í¬: {disk:.1f}%, í”„ë¡œì„¸ìŠ¤: {processes}ê°œ")
            
            report_lines.append("")
        
        # ê¶Œì¥ì‚¬í•­
        report_lines.append("ğŸ’¡ ê¶Œì¥ì‚¬í•­ ë° ê²°ë¡ ")
        report_lines.append("-" * 40)
        
        error_count = event_types.get('error', 0)
        warning_count = event_types.get('warning', 0)
        success_count = event_types.get('success', 0)
        
        if error_count == 0 and warning_count == 0:
            report_lines.append("âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            report_lines.append("   ëª¨ë“  ê²€ì¦ì´ í†µê³¼í–ˆìœ¼ë©° ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.")
        elif error_count == 0 and warning_count > 0:
            report_lines.append(f"âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ {warning_count}ê°œì˜ ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤.")
            report_lines.append("   ê²½ê³  ì‚¬í•­ì„ ê²€í† í•˜ê³  í•„ìš”ì‹œ ì¡°ì¹˜ë¥¼ ì·¨í•˜ì„¸ìš”.")
        else:
            report_lines.append(f"âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ {error_count}ê°œì˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            report_lines.append("   ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê±°ë‚˜ ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”.")
            report_lines.append("   ë¡¤ë°± ëª…ë ¹ì–´: ./rollback_migration.sh")
        
        report_lines.append("")
        report_lines.append("ğŸ“ ì§€ì› ì •ë³´:")
        report_lines.append("   - ë¡œê·¸ íŒŒì¼: " + str(self.log_file))
        report_lines.append("   - ë°ì´í„°ë² ì´ìŠ¤: " + str(self.db_path))
        report_lines.append("   - ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸: ./migration_verification_system.py")
        
        report_lines.append("")
        report_lines.append("=" * 80)
        
        report_content = "\n".join(report_lines)
        
        # ë³´ê³ ì„œ íŒŒì¼ ì €ì¥
        report_file = self.reports_dir / f"migration_report_{target_session}.txt"
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(report_content)
        
        self._print_colored(f"ğŸ“‹ ë³´ê³ ì„œ ì €ì¥ë¨: {report_file}", 'GREEN')
        
        return report_content
    
    def list_migration_sessions(self) -> List[Tuple[str, str, str]]:
        """ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT DISTINCT session_id, MIN(timestamp) as start_time, COUNT(*) as event_count
                FROM migration_events 
                GROUP BY session_id 
                ORDER BY start_time DESC
            ''')
            return cursor.fetchall()
    
    def cleanup_old_logs(self, days: int = 30):
        """ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬"""
        cutoff_date = datetime.now() - timedelta(days=days)
        
        # ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ ì‚­ì œ
        for log_file in self.log_dir.glob("migration_*.log"):
            if log_file.stat().st_mtime < cutoff_date.timestamp():
                log_file.unlink()
                self.logger.info(f"ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ ì‚­ì œ: {log_file}")
        
        # ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜¤ë˜ëœ ë ˆì½”ë“œ ì‚­ì œ
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                DELETE FROM migration_events 
                WHERE timestamp < ?
            ''', (cutoff_date.isoformat(),))
            
            cursor.execute('''
                DELETE FROM system_snapshots 
                WHERE timestamp < ?
            ''', (cutoff_date.isoformat(),))
            
            conn.commit()
        
        self.logger.info(f"{days}ì¼ ì´ì „ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ")
    
    def finalize_session(self, status: str = 'completed'):
        """ì„¸ì…˜ ì¢…ë£Œ"""
        # ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # ì´ë²¤íŠ¸ í†µê³„ ê³„ì‚°
            cursor.execute('''
                SELECT 
                    COUNT(*) as total_events,
                    SUM(CASE WHEN event_type = 'success' THEN 1 ELSE 0 END) as success_count,
                    SUM(CASE WHEN event_type = 'error' THEN 1 ELSE 0 END) as error_count,
                    SUM(CASE WHEN event_type = 'warning' THEN 1 ELSE 0 END) as warning_count
                FROM migration_events 
                WHERE session_id = ?
            ''', (self.session_id,))
            
            stats = cursor.fetchone()
            
            # ì„¸ì…˜ ì •ë³´ ì €ì¥
            cursor.execute('''
                INSERT OR REPLACE INTO migration_sessions 
                (session_id, start_time, end_time, status, total_events, success_count, error_count, warning_count)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                self.session_id, self.session_start.isoformat(), datetime.now().isoformat(),
                status, stats[0], stats[1], stats[2], stats[3]
            ))
            
            conn.commit()
        
        self.log_event('complete', 'session', f'ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜ ì¢…ë£Œ: {status}')

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    if len(sys.argv) < 2:
        print("ì‚¬ìš©ë²•: python3 migration_status_reporter.py [command] [options]")
        print("ëª…ë ¹ì–´:")
        print("  report [session_id]  - ë§ˆì´ê·¸ë ˆì´ì…˜ ë³´ê³ ì„œ ìƒì„±")
        print("  list                 - ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜ ëª©ë¡")
        print("  cleanup [days]       - ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (ê¸°ë³¸: 30ì¼)")
        print("  test                 - í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„±")
        sys.exit(1)
    
    command = sys.argv[1]
    reporter = MigrationStatusReporter()
    
    if command == "report":
        session_id = sys.argv[2] if len(sys.argv) > 2 else None
        report = reporter.generate_migration_report(session_id)
        print("\n" + report)
    
    elif command == "list":
        sessions = reporter.list_migration_sessions()
        print("\nğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸ì…˜ ëª©ë¡:")
        print("-" * 60)
        for session_id, start_time, event_count in sessions:
            start_dt = datetime.fromisoformat(start_time)
            print(f"{session_id}")
            print(f"  ì‹œì‘ ì‹œê°„: {start_dt.strftime('%Y-%m-%d %H:%M:%S')}")
            print(f"  ì´ë²¤íŠ¸ ìˆ˜: {event_count}ê°œ")
            print()
    
    elif command == "cleanup":
        days = int(sys.argv[2]) if len(sys.argv) > 2 else 30
        reporter.cleanup_old_logs(days)
        print(f"âœ… {days}ì¼ ì´ì „ ë¡œê·¸ ì •ë¦¬ ì™„ë£Œ")
    
    elif command == "test":
        # í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„±
        reporter.start_migration_phase("test", "í…ŒìŠ¤íŠ¸ ë‹¨ê³„")
        time.sleep(1)
        reporter.log_progress("test", "í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘", 50)
        time.sleep(1)
        reporter.log_warning("test", "í…ŒìŠ¤íŠ¸ ê²½ê³ ", {"test_key": "test_value"})
        time.sleep(1)
        reporter.complete_migration_phase("test", "í…ŒìŠ¤íŠ¸ ë‹¨ê³„", 3.0, True)
        reporter.finalize_session("test_completed")
        
        print("âœ… í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìƒì„± ì™„ë£Œ")
        
        # ë³´ê³ ì„œ ìƒì„±
        report = reporter.generate_migration_report()
        print("\n" + report)
    
    else:
        print(f"ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: {command}")
        sys.exit(1)

if __name__ == "__main__":
    main()