#!/usr/bin/env python3
"""
íŒŒì¼ëª… í‘œì¤€í™” ë„êµ¬
Filename Standardization Tool

ì£¼ìš” íŒŒì¼ë“¤ì˜ ì´ë¦„ì„ í‘œì¤€ ë„¤ì´ë° ê·œì¹™ì— ë§ê²Œ ë³€ê²½í•©ë‹ˆë‹¤.
"""

import posco_news_250808_monitor.log
# BROKEN_REF: import shutil
# BROKEN_REF: from pathlib import Path
# BROKEN_REF: from datetime import datetime
# BROKEN_REF: from typing import Dict, List, Tuple

class FilenameStandardizer:
    """íŒŒì¼ëª… í‘œì¤€í™” ë„êµ¬"""
    
    def __init__(self):
        self.workspace_root = Path.cwd()
        self.backup_dir = self.workspace_root / ".filename_standardization_backup"
        self.backup_dir.mkdir(exist_ok=True)
        
        # í‘œì¤€í™” ë§¤í•‘ (ê¸°ì¡´ â†’ ìƒˆë¡œìš´)
        self.file_mappings = {
            # Python íŒŒì¼ë“¤
            "POSCO_News_250808.py": "POSCO_News_250808.py",
            
            # ë¬¸ì„œ íŒŒì¼ë“¤
            ".filename_standardization_backup/.filename_standardization_backup/POSCO_WatchHamster_v3_Final_Summary.md.backup_20250809_182505.backup_20250809_182505": "WatchHamster_v3.0_Final_Summary.md",
            ".filename_standardization_backup/.filename_standardization_backup/POSCO_WatchHamster_v3_Complete_Guide.md.backup_20250809_182505.backup_20250809_182505": "WatchHamster_v3.0_Complete_Guide.md", 
            ".filename_standardization_backup/.filename_standardization_backup/POSCO_WatchHamster_v3_CrossPlatform_Guide.md.backup_20250809_182505.backup_20250809_182505": "WatchHamster_v3.0_CrossPlatform_Guide.md",
        }
        
        # í´ë” ë§¤í•‘
        self.folder_mappings = {
            "Monitoring/Posco_News_mini": "Monitoring/POSCO_News_250808_Legacy",
            "Monitoring/Posco_News_mini_v2": "Monitoring/WatchHamster_v3.0"
        }

    def standardize_all_files(self) -> Dict:
        """ëª¨ë“  íŒŒì¼ëª… í‘œì¤€í™”"""
        print("ğŸ”„ íŒŒì¼ëª… í‘œì¤€í™” ì‹œì‘")
        
        results = {
            "files_renamed": 0,
            "folders_renamed": 0,
            "errors": [],
            "success_files": [],
            "success_folders": []
        }
        
        # 1. íŒŒì¼ëª… ë³€ê²½
        for old_name, new_name in self.file_mappings.items():
            old_path = self.workspace_root / old_name
            if old_path.exists():
                success = self._rename_file(old_path, new_name)
                if success:
                    results["files_renamed"] += 1
                    results["success_files"].append(f"{old_name} â†’ {new_name}")
                    print(f"âœ… íŒŒì¼ ë³€ê²½: {old_name} â†’ {new_name}")
                else:
                    results["errors"].append(f"íŒŒì¼ ë³€ê²½ ì‹¤íŒ¨: {old_name}")
                    print(f"âŒ íŒŒì¼ ë³€ê²½ ì‹¤íŒ¨: {old_name}")
            else:
                print(f"âš ï¸ íŒŒì¼ ì—†ìŒ: {old_name}")
        
        # 2. í´ë”ëª… ë³€ê²½
        for old_name, new_name in self.folder_mappings.items():
            old_path = self.workspace_root / old_name
            if old_path.exists() and old_path.is_dir():
                success = self._rename_folder(old_path, new_name)
                if success:
                    results["folders_renamed"] += 1
                    results["success_folders"].append(f"{old_name} â†’ {new_name}")
                    print(f"âœ… í´ë” ë³€ê²½: {old_name} â†’ {new_name}")
                else:
                    results["errors"].append(f"í´ë” ë³€ê²½ ì‹¤íŒ¨: {old_name}")
                    print(f"âŒ í´ë” ë³€ê²½ ì‹¤íŒ¨: {old_name}")
            else:
                print(f"âš ï¸ í´ë” ì—†ìŒ: {old_name}")
        
        return results

    def _rename_file(self, old_path: Path, new_name: str) -> bool:
        """ê°œë³„ íŒŒì¼ ì´ë¦„ ë³€ê²½"""
        try:
            # ë°±ì—… ìƒì„±
            self._create_backup(old_path)
            
            # ìƒˆ ê²½ë¡œ ìƒì„±
            new_path = old_path.parent / new_name
            
            # íŒŒì¼ ì´ë¦„ ë³€ê²½
            old_path.rename(new_path)
            return True
            
        except Exception as e:
            print(f"íŒŒì¼ ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜: {e}")
            return False

    def _rename_folder(self, old_path: Path, new_name: str) -> bool:
        """ê°œë³„ í´ë” ì´ë¦„ ë³€ê²½"""
        try:
            # ìƒˆ ê²½ë¡œ ìƒì„±
            new_path = self.workspace_root / new_name
            
            # ìƒìœ„ ë””ë ‰í† ë¦¬ ìƒì„±
            new_path.parent.mkdir(parents=True, exist_ok=True)
            
            # í´ë” ì´ë¦„ ë³€ê²½
            old_path.rename(new_path)
            return True
            
        except Exception as e:
            print(f"í´ë” ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜: {e}")
            return False

    def _create_backup(self, file_path: Path):
        """íŒŒì¼ ë°±ì—… ìƒì„±"""
        try:
            if file_path.is_file():
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_name = f"{file_path.name}.backup_{timestamp}"
                backup_path = self.backup_dir / backup_name
                shutil.copy2(file_path, backup_path)
        except Exception as e:
            print(f"ë°±ì—… ìƒì„± ì‹¤íŒ¨: {e}")

    def update_references(self) -> Dict:
        """íŒŒì¼ëª… ë³€ê²½ì— ë”°ë¥¸ ì°¸ì¡° ì—…ë°ì´íŠ¸"""
        print("ğŸ”— íŒŒì¼ ì°¸ì¡° ì—…ë°ì´íŠ¸ ì¤‘...")
        
        results = {
            "files_updated": 0,
            "references_updated": 0,
            "errors": []
        }
        
        # Python íŒŒì¼ë“¤ì—ì„œ import êµ¬ë¬¸ ì—…ë°ì´íŠ¸
        python_files = list(self.workspace_root.rglob("*.py"))
        
        for py_file in python_files:
            try:
                with open(py_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                original_content = content
                
                # import êµ¬ë¬¸ ì—…ë°ì´íŠ¸
                for old_name, new_name in self.file_mappings.items():
                    if old_name.endswith('.py'):
                        old_module = old_name.replace('.py', '')
                        new_module = new_name.replace('.py', '')
                        
                        # import êµ¬ë¬¸ íŒ¨í„´ë“¤
                        patterns = [
# BROKEN_REF:                             f"import {old_module}",
# BROKEN_REF:                             f"from {old_module} import",
# BROKEN_REF:                             f"import {old_module} as",
                            f'"{old_name}"',
                            f"'{old_name}'"
                        ]
                        
                        replacements = [
# BROKEN_REF:                             f"import {new_module}",
# BROKEN_REF:                             f"from {new_module} import", 
# BROKEN_REF:                             f"import {new_module} as",
                            f'"{new_name}"',
                            f"'{new_name}'"
                        ]
                        
                        for pattern, replacement in zip(patterns, replacements):
                            if pattern in content:
                                content = content.replace(pattern, replacement)
                                results["references_updated"] += 1
                
                # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì €ì¥
                if content != original_content:
                    with open(py_file, 'w', encoding='utf-8') as f:
                        f.write(content)
                    results["files_updated"] += 1
                    print(f"âœ… ì°¸ì¡° ì—…ë°ì´íŠ¸: {py_file.name}")
                    
            except Exception as e:
                results["errors"].append(f"ì°¸ì¡° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ {py_file.name}: {e}")
                print(f"âŒ ì°¸ì¡° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {py_file.name}")
        
        return results

    def verify_changes(self) -> Dict:
        """ë³€ê²½ì‚¬í•­ ê²€ì¦"""
        print("ğŸ” ë³€ê²½ì‚¬í•­ ê²€ì¦ ì¤‘...")
        
        results = {
            "new_files_exist": 0,
            "old_files_removed": 0,
            "verification_errors": []
        }
        
        # ìƒˆ íŒŒì¼ë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        for old_name, new_name in self.file_mappings.items():
            new_path = self.workspace_root / new_name
            old_path = self.workspace_root / old_name
            
            if new_path.exists():
                results["new_files_exist"] += 1
                print(f"âœ… ìƒˆ íŒŒì¼ í™•ì¸: {new_name}")
            else:
                results["verification_errors"].append(f"ìƒˆ íŒŒì¼ ì—†ìŒ: {new_name}")
                print(f"âŒ ìƒˆ íŒŒì¼ ì—†ìŒ: {new_name}")
            
            if not old_path.exists():
                results["old_files_removed"] += 1
                print(f"âœ… ê¸°ì¡´ íŒŒì¼ ì œê±°ë¨: {old_name}")
        
        return results

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("ğŸš€ POSCO íŒŒì¼ëª… í‘œì¤€í™” ì‹œì‘")
    print("=" * 60)
    
    standardizer = FilenameStandardizer()
    
    # 1. íŒŒì¼ëª… í‘œì¤€í™”
    print("/n1ï¸âƒ£ íŒŒì¼ëª… í‘œì¤€í™” ì‹¤í–‰...")
    rename_results = standardizer.standardize_all_files()
    
    # 2. ì°¸ì¡° ì—…ë°ì´íŠ¸
    print("/n2ï¸âƒ£ íŒŒì¼ ì°¸ì¡° ì—…ë°ì´íŠ¸...")
    reference_results = standardizer.update_references()
    
    # 3. ë³€ê²½ì‚¬í•­ ê²€ì¦
    print("/n3ï¸âƒ£ ë³€ê²½ì‚¬í•­ ê²€ì¦...")
    verification_results = standardizer.verify_changes()
    
    # 4. ê²°ê³¼ ìš”ì•½
    print("/n" + "=" * 60)
    print("ğŸ‰ íŒŒì¼ëª… í‘œì¤€í™” ì™„ë£Œ!")
    print("=" * 60)
    
    print(f"/nğŸ“Š íŒŒì¼ëª… ë³€ê²½ ê²°ê³¼:")
    print(f"  âœ… íŒŒì¼ ë³€ê²½: {rename_results['files_renamed']}ê°œ")
    print(f"  âœ… í´ë” ë³€ê²½: {rename_results['folders_renamed']}ê°œ")
    print(f"  âŒ ì˜¤ë¥˜: {len(rename_results['errors'])}ê°œ")
    
    print(f"/nğŸ“Š ì°¸ì¡° ì—…ë°ì´íŠ¸ ê²°ê³¼:")
    print(f"  âœ… ì—…ë°ì´íŠ¸ëœ íŒŒì¼: {reference_results['files_updated']}ê°œ")
    print(f"  âœ… ì—…ë°ì´íŠ¸ëœ ì°¸ì¡°: {reference_results['references_updated']}ê°œ")
    print(f"  âŒ ì˜¤ë¥˜: {len(reference_results['errors'])}ê°œ")
    
    print(f"/nğŸ“Š ê²€ì¦ ê²°ê³¼:")
    print(f"  âœ… ìƒˆ íŒŒì¼ ì¡´ì¬: {verification_results['new_files_exist']}ê°œ")
    print(f"  âœ… ê¸°ì¡´ íŒŒì¼ ì œê±°: {verification_results['old_files_removed']}ê°œ")
    print(f"  âŒ ê²€ì¦ ì˜¤ë¥˜: {len(verification_results['verification_errors'])}ê°œ")
    
    if rename_results['success_files']:
        print(f"/nâœ… ì„±ê³µí•œ íŒŒì¼ ë³€ê²½:")
        for change in rename_results['success_files']:
            print(f"  - {change}")
    
    if rename_results['success_folders']:
        print(f"/nâœ… ì„±ê³µí•œ í´ë” ë³€ê²½:")
        for change in rename_results['success_folders']:
            print(f"  - {change}")
    
    total_errors = len(rename_results['errors']) + len(reference_results['errors']) + len(verification_results['verification_errors'])
    
    if total_errors == 0:
        print("/nğŸŠ ëª¨ë“  íŒŒì¼ëª… í‘œì¤€í™”ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        return 0
    else:
        print(f"/nâš ï¸ {total_errors}ê°œì˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
        return 1

if __name__ == "__main__":
    exit(main())