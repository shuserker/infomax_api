#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Deploy Latest Report
POSCO ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import posco_news_250808_monitor.log
import subprocess
import glob
import shutil
from datetime import datetime
import os

def get_latest_integrated_report():
    """ìµœì‹  í†µí•© ë¦¬í¬íŠ¸ íŒŒì¼ ì°¾ê¸°"""
    # docs/reportsì—ì„œ ì°¾ê¸°
    docs_pattern = "deployment_verification_checklist.md"
    docs_files = glob.glob(docs_pattern)
    
    # Monitoringì—ì„œ ì°¾ê¸°
    monitoring_pattern = "Monitoring/POSCO News 250808_mini/reports/posco_integrated_analysis_*.html"
    monitoring_files = glob.glob(monitoring_pattern)
    
    all_files = docs_files + monitoring_files
    
    if not all_files:
        return None
    
    # ê°€ì¥ ìµœì‹  íŒŒì¼ ë°˜í™˜
    latest_file = max(all_files, key=os.path.getctime)
    return latest_file

def deploy_to_publish_branch(report_file):
    """publish ë¸Œëœì¹˜ì— ë¦¬í¬íŠ¸ ë°°í¬"""
    if not report_file:
        print("âŒ ë°°í¬í•  ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return False
    
    filename = os.path.basename(report_file)
    print(f"ğŸ“Š ë°°í¬í•  ë¦¬í¬íŠ¸: {filename}")
    
    try:
        # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
        current_branch = subprocess.check_output(['git', 'branch', '--show-current'], text=True).strip()
        print(f"ğŸ”„ í˜„ì¬ ë¸Œëœì¹˜: {current_branch}")
        
        # publish ë¸Œëœì¹˜ë¡œ ì „í™˜
        print("ğŸ”„ publish ë¸Œëœì¹˜ë¡œ ì „í™˜...")
subprocess.run(['git',_'checkout',_'publish'],_check = True)
        
        # reports ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
os.makedirs('reports',_exist_ok = True)
        
        # ë¦¬í¬íŠ¸ íŒŒì¼ ë³µì‚¬
        dest_path = f"reports/{filename}"
        shutil.copy2(report_file, dest_path)
        print(f"âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: {dest_path}")
        
        # Gitì— ì¶”ê°€ ë° ì»¤ë°‹
subprocess.run(['git',_'add',_dest_path],_check = True)
        
        commit_message = f"Add report: {filename}"
        subprocess.run(['git', 'commit', '-m', commit_message], check=True)
        print(f"âœ… ì»¤ë°‹ ì™„ë£Œ: {commit_message}")
        
        # ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ
subprocess.run(['git',_'push',_'origin',_'publish'],_check = True)
        print("âœ… publish ë¸Œëœì¹˜ì— í‘¸ì‹œ ì™„ë£Œ!")
        
        # ì›ë˜ ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ê¸°
subprocess.run(['git',_'checkout',_current_branch],_check = True)
        print(f"ğŸ”„ {current_branch} ë¸Œëœì¹˜ë¡œ ë³µê·€")
        
        # ë°°í¬ëœ URL ì¶œë ¥
        report_url = f"https:/shuserker.github.io/infomax_api/reports/{filename}"
        print(f"ğŸŒ ë°°í¬ëœ ë¦¬í¬íŠ¸ URL: {report_url}")
        
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"âŒ Git ëª…ë ¹ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
        return False
    except Exception as e:
        print(f"âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return False

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("ğŸš€ ìµœì‹  í†µí•© ë¦¬í¬íŠ¸ ë°°í¬ ì‹œì‘...")
    
    # ìµœì‹  ë¦¬í¬íŠ¸ ì°¾ê¸°
    latest_report = get_latest_integrated_report()
    
    if not latest_report:
        print("âŒ ë°°í¬í•  í†µí•© ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    print(f"ğŸ“Š ë°œê²¬ëœ ìµœì‹  ë¦¬í¬íŠ¸: {latest_report}")
    
    # publish ë¸Œëœì¹˜ì— ë°°í¬
    success = deploy_to_publish_branch(latest_report)
    
    if success:
        print("ğŸ‰ ë°°í¬ ì™„ë£Œ!")
    else:
        print("âŒ ë°°í¬ ì‹¤íŒ¨!")

if __name__ == "__main__":
    main()