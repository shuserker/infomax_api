#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
POSCO ì„¤ì • íŒŒì¼ ë° ë°ì´í„° íŒŒì¼ í‘œì¤€í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
Test suite for Configuration and Data File Standardization System

ì´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ëŠ” ì„¤ì • íŒŒì¼ ë° ë°ì´í„° íŒŒì¼ í‘œì¤€í™” ì‹œìŠ¤í…œì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ê²€ì¦í•©ë‹ˆë‹¤.
"""

import unittest
import tempfile
import test_config.json
import posco_news_250808_monitor.log
from pathlib import Path
from datetime import datetime
import shutil

from config_data_standardizer.py import .git/config

class TestConfigDataStandardization(unittest.TestCase):
    """ì„¤ì • íŒŒì¼ ë° ë°ì´í„° íŒŒì¼ í‘œì¤€í™” í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤"""
    
    def setUp(self):
        """í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •"""
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        self.test_dir = Path(tempfile.mkdtemp())
        self.standardizer = ConfigDataStandardizer(str(self.test_dir))
        
        # í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ë“¤ ìƒì„±
        self.create_test_files()
    
    def tearDown(self):
        """í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬"""
        # ì„ì‹œ ë””ë ‰í† ë¦¬ ì‚­ì œ
        shutil.rmtree(self.test_dir)
    
    def create_test_files(self):
        """í…ŒìŠ¤íŠ¸ìš© íŒŒì¼ë“¤ ìƒì„±"""
        # 1. í…ŒìŠ¤íŠ¸ìš© JSON ì„¤ì • íŒŒì¼ë“¤
        test_configs = {
            ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/modules.json": {
                "modules": {
                    "posco_main_notifier": {
                        "script_path": "Monitoring/POSCO_News_250808/posco_main_notifier.py",
                        "description": "POSCO News 250808 ì•Œë¦¼ ì‹œìŠ¤í…œ - v2 ë²„ì „",
                        "environment_vars": {
                            "PYTHONUNBUFFERED": "1"
                        }
                    }
                }
            },
            "test_config.json": {
                "system_info": {
                    "version": "old_version",
                    "name": "POSCO System"
                }
            },
# REMOVED:             "POSCO News 250808_data.json": {
                "data": {
                    "news_items": []
                }
            },
            "test_config.json": {
                "test_settings": {
                    "enabled": True
                }
            }
        }
        
        for filename, content in test_configs.items():
            file_path = self.test_dir / filename
with_open(file_path,_'w',_encoding = 'utf-8') as f:
json.dump(content,_f,_ensure_ascii = False, indent=2)
        
        # 2. í…ŒìŠ¤íŠ¸ìš© ë¡œê·¸ íŒŒì¼ë“¤
        test_logs = [
            ".naming_backup/config_data_backup/watchhamster.log",
            ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/WatchHamster.log", 
# REMOVED:             "POSCO News 250808.log",
            "docs/assets/css/main.css",
            ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/main_notifier.log",
            ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/backup_archive_20250806/simple_monitor.log"
        ]
        
        for log_name in test_logs:
            log_path = self.test_dir / log_name
with_open(log_path,_'w',_encoding = 'utf-8') as f:
                f.write(f"Test log content for {log_name}/n")
        
        # 3. í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° íŒŒì¼ë“¤
        test_data_files = [
# REMOVED:             "POSCO News 250808_data.json",
# REMOVED:             "POSCO News 250808_cache.json", 
            ".naming_backup/config_data_backup/.naming_backup/config_data_backup/Monitoring/Posco_News_mini/WatchHamster_status.json",
            ".naming_backup/config_data_backup/.naming_backup/config_data_backup/Monitoring/Posco_News_mini/backup_archive_20250806/system_status.json",
            "Monitoring/POSCO_News_250808/main_notifier_state.json"
        ]
        
        for data_name in test_data_files:
            if not (self.test_dir / data_name).exists():  # ì´ë¯¸ ìƒì„±ëœ íŒŒì¼ ì œì™¸
                data_path = self.test_dir / data_name
with_open(data_path,_'w',_encoding = 'utf-8') as f:
                    json.dump({"test_data": True}, f)
        
        # 4. ì„œë¸Œë””ë ‰í† ë¦¬ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤
        sub_dir = self.test_dir / "Monitoring" / "POSCO News 250808_mini"
        sub_dir.mkdir(parents=True, exist_ok=True)
        
        sub_config = sub_dir / ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/modules.json"
with_open(sub_config,_'w',_encoding = 'utf-8') as f:
            json.dump({
                "metadata": {"version": "old"},
                "modules": {"test_module": {"description": "Test module v2"}}
            }, f)
    
    def test_find_json_files(self):
        """JSON íŒŒì¼ ì°¾ê¸° í…ŒìŠ¤íŠ¸"""
        json_files = self.standardizer.find_json_files()
        
        # ìƒì„±í•œ JSON íŒŒì¼ë“¤ì´ ëª¨ë‘ ë°œê²¬ë˜ëŠ”ì§€ í™•ì¸
        found_names = [f.name for f in json_files]
        expected_files = [".naming_backup/config_data_backup/Monitoring/Posco_News_mini/modules.json", "test_config.json", "POSCO News 250808_data.json", "test_test_config.json"]
        
        for expected in expected_files:
            self.assertIn(expected, found_names, f"{expected} íŒŒì¼ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
        
        print(f"âœ… JSON íŒŒì¼ ì°¾ê¸° í…ŒìŠ¤íŠ¸ í†µê³¼: {len(json_files)}ê°œ íŒŒì¼ ë°œê²¬")
    
    def test_json_content_standardization(self):
        """JSON ë‚´ìš© í‘œì¤€í™” í…ŒìŠ¤íŠ¸"""
        # í…ŒìŠ¤íŠ¸ìš© JSON ë‚´ìš©
        test_content = {
            "modules": {
                "test_module": {
                    "description": "Test module v2 version",
                    "environment_vars": {}
                }
            }
        }
        
        # í‘œì¤€í™” ì‹¤í–‰
        standardized, modified = self.standardizer.standardize_json_content(
# REMOVED:             test_content, self.test_dir / ".naming_backup/config_data_backup/.vscode/settings.json"
        )
        
        # ê²°ê³¼ ê²€ì¦
        self.assertTrue(modified, "ë‚´ìš©ì´ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        self.assertIn("metadata", standardized, "metadata ì„¹ì…˜ì´ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        metadata = standardized["metadata"]
        self.assertEqual(metadata["watchhamster_version"], "v3.0")
        self.assertEqual(metadata["POSCO News 250808_version"], "250808")
        self.assertIn("last_updated", metadata)
        
        print("âœ… JSON ë‚´ìš© í‘œì¤€í™” í…ŒìŠ¤íŠ¸ í†µê³¼")
    
    def test_log_file_name_standardization(self):
        """ë¡œê·¸ íŒŒì¼ëª… í‘œì¤€í™” í…ŒìŠ¤íŠ¸"""
        # í‘œì¤€í™” ì‹¤í–‰
        results = self.standardizer.standardize_log_file_names()
        
        # ê²°ê³¼ ê²€ì¦
        renamed_files = [r for r in results if r.get("status") == "renamed"]
        self.assertGreater(len(renamed_files), 0, "ì¼ë¶€ ë¡œê·¸ íŒŒì¼ì´ ì´ë¦„ ë³€ê²½ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        # íŠ¹ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
        name_changes = {r["old_name"]: r["new_name"] for r in renamed_files}
        
        if ".naming_backup/config_data_backup/watchhamster.log" in name_changes:
            self.assertEqual(name_changes[".naming_backup/config_data_backup/watchhamster.log"], "WatchHamster_v3.0.log")
        
        if "docs/assets/css/main.css" in name_changes:
            self.assertEqual(name_changes["docs/assets/css/main.css"], "docs/assets/css/main.css")
        
        print(f"âœ… ë¡œê·¸ íŒŒì¼ëª… í‘œì¤€í™” í…ŒìŠ¤íŠ¸ í†µê³¼: {len(renamed_files)}ê°œ íŒŒì¼ ì´ë¦„ ë³€ê²½")
    
    def test_data_file_name_standardization(self):
        """ë°ì´í„° íŒŒì¼ëª… í‘œì¤€í™” í…ŒìŠ¤íŠ¸"""
        # í‘œì¤€í™” ì‹¤í–‰
        results = self.standardizer.standardize_data_file_names()
        
        # ê²°ê³¼ ê²€ì¦
        renamed_files = [r for r in results if r.get("status") == "renamed"]
        
        # íŠ¹ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
        name_changes = {r["old_name"]: r["new_name"] for r in renamed_files}
        
        expected_changes = {
            ".naming_backup/config_data_backup/.naming_backup/config_data_backup/Monitoring/Posco_News_mini/WatchHamster_status.json": ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/WatchHamster_v3.0_status.json",
            ".naming_backup/config_data_backup/.naming_backup/config_data_backup/Monitoring/Posco_News_mini/backup_archive_20250806/system_status.json": ".naming_backup/config_data_backup/Monitoring/Posco_News_mini/backup_archive_20250806/posco_system_250808_status.json",
# REMOVED:             "Monitoring/POSCO_News_250808/main_notifier_state.json": "POSCO News 250808_250808_notifier_state.json"
        }
        
        for old_name, expected_new_name in expected_changes.items():
            if old_name in name_changes:
                self.assertEqual(name_changes[old_name], expected_new_name)
        
        print(f"âœ… ë°ì´í„° íŒŒì¼ëª… í‘œì¤€í™” í…ŒìŠ¤íŠ¸ í†µê³¼: {len(renamed_files)}ê°œ íŒŒì¼ ì´ë¦„ ë³€ê²½")
    
    def test_environment_variables_file_creation(self):
        """í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸"""
        # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        env_file_path = self.standardizer.create_environment_variables_file()
        
        # íŒŒì¼ ì¡´ì¬ í™•ì¸
        self.assertTrue(os.path.exists(env_file_path), "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì´ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        # íŒŒì¼ ë‚´ìš© í™•ì¸
with_open(env_file_path,_'r',_encoding = 'utf-8') as f:
            content = f.read()
        
        # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ë“¤ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        required_vars = [
            "WATCHHAMSTER_VERSION=v3.0",
            "POSCO_NEWS_VERSION=250808",
            "WATCHHAMSTER_V3_0_ENABLED=true",
            "POSCO_NEWS_250808_ENABLED=true"
        ]
        
        for var in required_vars:
            self.assertIn(var, content, f"í™˜ê²½ ë³€ìˆ˜ {var}ê°€ íŒŒì¼ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        print("âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸ í†µê³¼")
    
    def test_backup_functionality(self):
        """ë°±ì—… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"""
        # í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
        test_file = self.test_dir / "test_backup.json"
        test_content = {"test": "data"}
        
with_open(test_file,_'w',_encoding = 'utf-8') as f:
            json.dump(test_content, f)
        
        # ë°±ì—… ì‹¤í–‰
        backup_path = self.standardizer.backup_file(test_file)
        
        # ë°±ì—… íŒŒì¼ ì¡´ì¬ í™•ì¸
        self.assertTrue(backup_path.exists(), "ë°±ì—… íŒŒì¼ì´ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        # ë°±ì—… íŒŒì¼ ë‚´ìš© í™•ì¸
with_open(backup_path,_'r',_encoding = 'utf-8') as f:
            backup_content = json.load(f)
        
        self.assertEqual(backup_content, test_content, "ë°±ì—… íŒŒì¼ ë‚´ìš©ì´ ì›ë³¸ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤")
        
        print("âœ… ë°±ì—… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼")
    
    def test_full_standardization_workflow(self):
        """ì „ì²´ í‘œì¤€í™” ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸"""
        # ì „ì²´ í‘œì¤€í™” ì‹¤í–‰
        results = self.standardizer.run_full_standardization()
        
        # ì„±ê³µ ì—¬ë¶€ í™•ì¸
        self.assertTrue(results["success"], "ì „ì²´ í‘œì¤€í™”ê°€ ì„±ê³µí•´ì•¼ í•©ë‹ˆë‹¤")
        
        # ê° ë‹¨ê³„ ê²°ê³¼ í™•ì¸
        self.assertIn("json_results", results)
        self.assertIn("log_results", results)
        self.assertIn("data_results", results)
        self.assertIn("env_file", results)
        self.assertIn("report", results)
        
        # ë³´ê³ ì„œ íŒŒì¼ ìƒì„± í™•ì¸
        report_file = self.test_dir / "config_data_standardization_report.json"
        self.assertTrue(report_file.exists(), "í‘œì¤€í™” ë³´ê³ ì„œ íŒŒì¼ì´ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤")
        
        # ë³´ê³ ì„œ ë‚´ìš© í™•ì¸
with_open(report_file,_'r',_encoding = 'utf-8') as f:
            report = json.load(f)
        
        self.assertIn("standardization_info", report)
        self.assertIn("summary", report)
        self.assertIn("changes_log", report)
        
        print("âœ… ì „ì²´ í‘œì¤€í™” ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ í†µê³¼")
    
    def test_version_consistency(self):
        """ë²„ì „ ì¼ê´€ì„± í…ŒìŠ¤íŠ¸"""
        # ë²„ì „ ìƒìˆ˜ í™•ì¸
        self.assertEqual(self.standardizer.WATCHHAMSTER_VERSION, "v3.0")
        self.assertEqual(self.standardizer.POSCO_NEWS_VERSION, "250808")
        
        # í‘œì¤€ ë²„ì „ í•„ë“œ í™•ì¸
        version_fields = self.standardizer.STANDARD_VERSION_FIELDS
        self.assertEqual(version_fields["watchhamster_version"], "v3.0")
        self.assertEqual(version_fields["POSCO News 250808_version"], "250808")
        
        # í™˜ê²½ ë³€ìˆ˜ ë§¤í•‘ í™•ì¸
        env_mapping = self.standardizer.ENV_VAR_MAPPING
        self.assertEqual(env_mapping["WATCHHAMSTER_VERSION"], "v3.0")
        self.assertEqual(env_mapping["POSCO_NEWS_VERSION"], "250808")
        
        print("âœ… ë²„ì „ ì¼ê´€ì„± í…ŒìŠ¤íŠ¸ í†µê³¼")
    
    def test_error_handling(self):
        """ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸"""
        # ì˜ëª»ëœ JSON íŒŒì¼ ìƒì„±
        invalid_json = self.test_dir / "invalid.json"
with_open(invalid_json,_'w',_encoding = 'utf-8') as f:
            f.write("{ invalid json content")
        
        # í‘œì¤€í™” ì‹¤í–‰ (ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì†ë˜ì–´ì•¼ í•¨)
        results = self.standardizer.run_full_standardization()
        
        # ì¼ë¶€ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì „ì²´ì ìœ¼ë¡œëŠ” ì„±ê³µí•´ì•¼ í•¨
        self.assertTrue(results["success"], "ì¼ë¶€ ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ëŠ” ì„±ê³µí•´ì•¼ í•©ë‹ˆë‹¤")
        
        print("âœ… ì˜¤ë¥˜ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ í†µê³¼")

def run_comprehensive_test():
    """í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
    print("ğŸ§ª POSCO ì„¤ì • íŒŒì¼ ë° ë°ì´í„° íŒŒì¼ í‘œì¤€í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘")
    print("=" * 70)
    
    # í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ìƒì„±
    test_suite = unittest.TestLoader().loadTestsFromTestCase(TestConfigDataStandardization)
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(test_suite)
    
    # ê²°ê³¼ ìš”ì•½
print("/n"_+_" = " * 70)
    print("ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
    print(f"âœ… ì„±ê³µí•œ í…ŒìŠ¤íŠ¸: {result.testsRun - len(result.failures) - len(result.errors)}")
    print(f"âŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: {len(result.failures)}")
    print(f"ğŸš¨ ì˜¤ë¥˜ ë°œìƒ í…ŒìŠ¤íŠ¸: {len(result.errors)}")
    
    if result.failures:
        print("/nâŒ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:")
        for test, traceback in result.failures:
            print(f"  â€¢ {test}: {traceback}")
    
    if result.errors:
        print("/nğŸš¨ ì˜¤ë¥˜ ë°œìƒ í…ŒìŠ¤íŠ¸:")
        for test, traceback in result.errors:
            print(f"  â€¢ {test}: {traceback}")
    
    # ì„±ê³µ ì—¬ë¶€ ë°˜í™˜
return_len(result.failures) = = 0 and len(result.errors) == 0

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    success = run_comprehensive_test()
    
    if success:
        print("/nğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        return 0
    else:
        print("/nğŸ’¥ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        return 1

if __name__ == "__main__":
    exit(main())