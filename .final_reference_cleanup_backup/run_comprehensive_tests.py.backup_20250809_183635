#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Run Comprehensive Tests
POSCO ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

WatchHamster v3.0 ë° POSCO News 250808 í˜¸í™˜
Created: 2025-08-08
"""

import posco_news_250808_monitor.log
import system_functionality_verification.py
# BROKEN_REF: import subprocess
import .comprehensive_repair_backup/realtime_news_monitor.py.backup_20250809_181657
import test_config.json
# BROKEN_REF: from datetime import datetime
# BROKEN_REF: from typing import deployment_verification_checklist.md, Dict, Tuple

class ComprehensiveTestRunner:
    """ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ê¸°"""
    
    def __init__(self):
        self.script_dir = os.path.dirname(os.path.abspath(__file__))
        self.test_results = {}
        self.start_time = None
        self.end_time = None
        
        # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡
        self.test_scripts = [
            {
                'name': 'V2 Integration Tests',
# BROKEN_REF:                 'script': 'final_integration_test_system.py',
                'description': 'v2 ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™” ë° í†µí•© í…ŒìŠ¤íŠ¸',
                'timeout': 120,
                'critical': True
            },
            {
                'name': 'Process Lifecycle Tests',
                'script': 'test_process_lifecycle.py',
                'description': 'í”„ë¡œì„¸ìŠ¤ ìƒëª…ì£¼ê¸° ê´€ë¦¬ í…ŒìŠ¤íŠ¸',
                'timeout': 180,
                'critical': True
            },
            {
                'name': 'Control Center Integration Tests',
                'script': 'test_control_center_integration.py',
                'description': 'ì œì–´ì„¼í„° í†µí•© ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸',
                'timeout': 90,
                'critical': False
            },
            {
                'name': 'End-to-End Integration Tests',
                'script': 'test_end_to_end_integration.py',
                'description': 'ì—”ë“œíˆ¬ì—”ë“œ í†µí•© í…ŒìŠ¤íŠ¸ ë° ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸',
                'timeout': 300,
                'critical': True
            }
        ]
    
    def print_header(self, title: str, char: str = "=", width: int = 80):
        """í—¤ë” ì¶œë ¥"""
        print(char * width)
        print(f"{title:^{width}}")
        print(char * width)
    
    def print_section(self, title: str, char: str = "-", width: int = 60):
        """ì„¹ì…˜ í—¤ë” ì¶œë ¥"""
        print(f"/n{char * width}")
        print(f"{title}")
        print(f"{char * width}")
    
    def run_single_test(self, test_config: Dict) -> Dict:
        """ë‹¨ì¼ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
        test_name = test_config['name']
        script_path = os.path.join(self.script_dir, test_config['script'])
        timeout = test_config.get('timeout', 60)
        
        print(f"ğŸ§ª {test_name} ì‹¤í–‰ ì¤‘...")
        print(f"   ìŠ¤í¬ë¦½íŠ¸: {test_config['script']}")
        print(f"   ì„¤ëª…: {test_config['description']}")
        print(f"   íƒ€ì„ì•„ì›ƒ: {timeout}ì´ˆ")
        
        result = {
            'name': test_name,
            'script': test_config['script'],
            'start_time': datetime.now(),
            'success': False,
            'return_code': None,
            'stdout': '',
            'stderr': '',
            'duration': 0,
            'error_message': None
        }
        
        try:
            # ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ í™•ì¸
            if not os.path.exists(script_path):
                raise FileNotFoundError(f"í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {script_path}")
            
            # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            start_time = time.time()
            
            process = subprocess.run([
                sys.executable, script_path
],_capture_output = True, text=True, timeout=timeout, cwd=self.script_dir)
            
            end_time = time.time()
            result['duration'] = end_time - start_time
            result['return_code'] = process.returncode
            result['stdout'] = process.stdout
            result['stderr'] = process.stderr
            
            if process.returncode == 0:
                result['success'] = True
                print(f"âœ… {test_name} ì„±ê³µ (ì†Œìš”ì‹œê°„: {result['duration']:.2f}ì´ˆ)")
            else:
                result['success'] = False
                result['error_message'] = f"í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (return code: {process.returncode})"
                print(f"âŒ {test_name} ì‹¤íŒ¨ (return code: {process.returncode})")
                
                # ì˜¤ë¥˜ ì¶œë ¥ (ì²˜ìŒ 500ìë§Œ)
                if process.stderr:
                    print(f"   ì˜¤ë¥˜: {process.stderr[:500]}...")
                    
        except subprocess.TimeoutExpired:
            result['error_message'] = f"í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ ({timeout}ì´ˆ)"
            print(f"â° {test_name} íƒ€ì„ì•„ì›ƒ ({timeout}ì´ˆ)")
            
        except FileNotFoundError as e:
            result['error_message'] = str(e)
            print(f"ğŸ“ {test_name} íŒŒì¼ ì˜¤ë¥˜: {e}")
            
        except Exception as e:
            result['error_message'] = str(e)
            print(f"âŒ {test_name} ì˜ˆì™¸ ë°œìƒ: {e}")
        
        result['end_time'] = datetime.now()
        return result
    
    def analyze_test_output(self, result: Dict) -> Dict:
        """í…ŒìŠ¤íŠ¸ ì¶œë ¥ ë¶„ì„"""
        analysis = {
            'total_tests': 0,
            'passed_tests': 0,
            'failed_tests': 0,
            'success_rate': 0.0,
            'key_metrics': {},
            'warnings': [],
            'errors': []
        }
        
        stdout = result.get('stdout', '')
        stderr = result.get('stderr', '')
        
        # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒ¨í„´ ë¶„ì„
        if 'í…ŒìŠ¤íŠ¸' in stdout:
            # ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ì¶”ì¶œ
            lines = stdout.split('/n')
            for line in lines:
                if 'ì„±ê³µ' in line and 'ì‹¤íŒ¨' in line:
                    # "ì´ Xê°œ í…ŒìŠ¤íŠ¸ ì¤‘ Yê°œ ì„±ê³µ, Zê°œ ì‹¤íŒ¨" íŒ¨í„´ ì°¾ê¸°
                    try:
                        if 'ì´' in line and 'ê°œ í…ŒìŠ¤íŠ¸' in line:
                            parts = line.split()
                            for i, part in enumerate(parts):
                                if part == 'ì´' and i + 2 < len(parts):
                                    analysis['total_tests'] = int(parts[i + 1].replace('ê°œ', ''))
                                elif part.endswith('ê°œ') and 'ì„±ê³µ' in parts[i + 1]:
                                    analysis['passed_tests'] = int(part.replace('ê°œ', ''))
                                elif part.endswith('ê°œ') and 'ì‹¤íŒ¨' in parts[i + 1]:
                                    analysis['failed_tests'] = int(part.replace('ê°œ', ''))
                    except (ValueError, IndexError):
                        pass
        
        # ì„±ê³µë¥  ê³„ì‚°
        if analysis['total_tests'] > 0:
            analysis['success_rate'] = (analysis['passed_tests'] / analysis['total_tests']) * 100
        
        # ê²½ê³  ë° ì˜¤ë¥˜ ì¶”ì¶œ
        for line in stdout.split('/n') + stderr.split('/n'):
            if 'âš ï¸' in line or 'WARNING' in line.upper():
                analysis['warnings'].append(line.strip())
            elif 'âŒ' in line or 'ERROR' in line.upper():
                analysis['errors'].append(line.strip())
        
        return analysis
    
    def generate_summary_report(self) -> str:
        """ìš”ì•½ ë³´ê³ ì„œ ìƒì„±"""
        total_duration = (self.end_time - self.start_time).total_seconds()
        
        # ì „ì²´ í†µê³„
        total_scripts = len(self.test_results)
        successful_scripts = sum(1 for r in self.test_results.values() if r['success'])
        failed_scripts = total_scripts - successful_scripts
        
        # ê°œë³„ í…ŒìŠ¤íŠ¸ í†µê³„ ì§‘ê³„
        total_individual_tests = 0
        total_passed_tests = 0
        total_failed_tests = 0
        
        for result in self.test_results.values():
            analysis = self.analyze_test_output(result)
total_individual_tests_+ =  analysis['total_tests']
total_passed_tests_+ =  analysis['passed_tests']
total_failed_tests_+ =  analysis['failed_tests']
        
        # ë³´ê³ ì„œ ìƒì„±
        report = f"""
ğŸ¯ POSCO WatchHamster v3.0 ì¢…í•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ
{'=' * 80}

ğŸ“Š ì „ì²´ ì‹¤í–‰ í†µê³„
â€¢ ì‹¤í–‰ ì‹œê°„: {total_duration:.2f}ì´ˆ
â€¢ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸: {total_scripts}ê°œ
â€¢ ì„±ê³µí•œ ìŠ¤í¬ë¦½íŠ¸: {successful_scripts}ê°œ
â€¢ ì‹¤íŒ¨í•œ ìŠ¤í¬ë¦½íŠ¸: {failed_scripts}ê°œ
â€¢ ìŠ¤í¬ë¦½íŠ¸ ì„±ê³µë¥ : {(successful_scripts/total_scripts*100):.1f}%

ğŸ“ˆ ê°œë³„ í…ŒìŠ¤íŠ¸ í†µê³„
â€¢ ì´ ê°œë³„ í…ŒìŠ¤íŠ¸: {total_individual_tests}ê°œ
â€¢ í†µê³¼í•œ í…ŒìŠ¤íŠ¸: {total_passed_tests}ê°œ
â€¢ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: {total_failed_tests}ê°œ
â€¢ ê°œë³„ í…ŒìŠ¤íŠ¸ ì„±ê³µë¥ : {(total_passed_tests/total_individual_tests*100):.1f}% (ì´ í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°)

ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ë³„ ìƒì„¸ ê²°ê³¼
{'-' * 80}
"""
        
        for script_config in self.test_scripts:
            script_name = script_config['script']
            if script_name in self.test_results:
                result = self.test_results[script_name]
                analysis = self.analyze_test_output(result)
                
                status = "âœ… ì„±ê³µ" if result['success'] else "âŒ ì‹¤íŒ¨"
                critical = "ğŸ”´ ì¤‘ìš”" if script_config.get('critical', False) else "ğŸŸ¡ ì¼ë°˜"
                
report_+ =  f"""
{status} {result['name']} ({critical})
â€¢ ìŠ¤í¬ë¦½íŠ¸: {script_name}
â€¢ ì†Œìš”ì‹œê°„: {result['duration']:.2f}ì´ˆ
â€¢ ê°œë³„ í…ŒìŠ¤íŠ¸: {analysis['total_tests']}ê°œ (ì„±ê³µ: {analysis['passed_tests']}, ì‹¤íŒ¨: {analysis['failed_tests']})
â€¢ ì„±ê³µë¥ : {analysis['success_rate']:.1f}%
"""
                
                if not result['success']:
                    report += f"â€¢ ì˜¤ë¥˜: {result.get('error_message', 'Unknown error')}/n"
                
                if analysis['warnings']:
report_+ =  f"â€¢ ê²½ê³ : {len(analysis['warnings'])}ê°œ/n"
        
        # ê¶Œì¥ì‚¬í•­
report_+ =  f"""
{'-' * 80}
ğŸ”§ ê¶Œì¥ì‚¬í•­ ë° ë‹¤ìŒ ë‹¨ê³„

"""
        
        if failed_scripts == 0:
report_+ =  """âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!
â€¢ v2 í†µí•© ì‹œìŠ¤í…œì´ ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.
â€¢ í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.
â€¢ ì •ê¸°ì ì¸ íšŒê·€ í…ŒìŠ¤íŠ¸ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
"""
        else:
report_+ =  f"""âš ï¸ {failed_scripts}ê°œì˜ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
â€¢ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ê°œë³„ì ìœ¼ë¡œ ê²€í† í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”.
â€¢ ì¤‘ìš”(ğŸ”´) í…ŒìŠ¤íŠ¸ì˜ ì‹¤íŒ¨ëŠ” ìš°ì„ ì ìœ¼ë¡œ í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤.
â€¢ ìˆ˜ì • í›„ ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.
"""
        
        # ìƒì„¸ ë¡œê·¸ ìœ„ì¹˜
report_+ =  f"""
ğŸ“ ìƒì„¸ ë¡œê·¸ ë° ì¶œë ¥
â€¢ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë””ë ‰í† ë¦¬: {self.script_dir}
â€¢ ê°œë³„ í…ŒìŠ¤íŠ¸ ì¶œë ¥ì€ ê° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œ í™•ì¸ ê°€ëŠ¥
â€¢ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ì˜ ìƒì„¸ ì˜¤ë¥˜ëŠ” stderr ì¶œë ¥ ì°¸ì¡°

ìƒì„± ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
"""
        
        return report
    
    def save_detailed_results(self):
        """ìƒì„¸ ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥"""
        results_file = os.path.join(self.script_dir, 'test_results.json')
        
        # ê²°ê³¼ ë°ì´í„° ì¤€ë¹„ (datetime ê°ì²´ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜)
        serializable_results = {}
        for script_name, result in self.test_results.items():
            serializable_result = result.copy()
            serializable_result['start_time'] = result['start_time'].isoformat()
            serializable_result['end_time'] = result['end_time'].isoformat()
            serializable_result['analysis'] = self.analyze_test_output(result)
            serializable_results[script_name] = serializable_result
        
        # ë©”íƒ€ë°ì´í„° ì¶”ê°€
        test_session = {
            'session_start': self.start_time.isoformat(),
            'session_end': self.end_time.isoformat(),
            'total_duration': (self.end_time - self.start_time).total_seconds(),
            'test_scripts': self.test_scripts,
            'results': serializable_results
        }
        
        try:
with_open(results_file,_'w',_encoding = 'utf-8') as f:
json.dump(test_session,_f,_indent = 2, ensure_ascii=False)
            
            print(f"ğŸ“ ìƒì„¸ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {results_file}")
            
        except Exception as e:
            print(f"âš ï¸ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨: {e}")
    
    def run_all_tests(self) -> bool:
        """ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
        self.start_time = datetime.now()
        
        self.print_header("ğŸš€ POSCO WatchHamster v3.0 ì¢…í•© í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬")
        print(f"ì‹œì‘ ì‹œê°„: {self.start_time.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸: {len(self.test_scripts)}ê°œ")
        print()
        
        # ê°œë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        for i, test_config in enumerate(self.test_scripts, 1):
            self.print_section(f"ğŸ“‹ í…ŒìŠ¤íŠ¸ {i}/{len(self.test_scripts)}: {test_config['name']}")
            
            result = self.run_single_test(test_config)
            self.test_results[test_config['script']] = result
            
            print()
        
        self.end_time = datetime.now()
        
        # ê²°ê³¼ ìš”ì•½
        self.print_header("ğŸ“Š ì¢…í•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½")
        
        summary_report = self.generate_summary_report()
        print(summary_report)
        
        # ìƒì„¸ ê²°ê³¼ ì €ì¥
        self.save_detailed_results()
        
        # ì „ì²´ ì„±ê³µ ì—¬ë¶€ íŒë‹¨
        critical_failures = 0
        total_failures = 0
        
        for test_config in self.test_scripts:
            script_name = test_config['script']
            if script_name in self.test_results:
                result = self.test_results[script_name]
                if not result['success']:
total_failures_+ =  1
                    if test_config.get('critical', False):
critical_failures_+ =  1
        
        # ì¤‘ìš”í•œ í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ ì„±ê³µí•˜ë©´ ì „ì²´ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
        if critical_failures == 0:
            print("/nğŸ‰ ëª¨ë“  ì¤‘ìš” í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
            if total_failures > 0:
                print(f"âš ï¸ ì¼ë°˜ í…ŒìŠ¤íŠ¸ {total_failures}ê°œê°€ ì‹¤íŒ¨í–ˆì§€ë§Œ, ì‹œìŠ¤í…œì€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            return True
        else:
            print(f"/nâŒ ì¤‘ìš” í…ŒìŠ¤íŠ¸ {critical_failures}ê°œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
            print("ğŸ”§ ì‹¤íŒ¨í•œ ì¤‘ìš” í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.")
            return False


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    runner = ComprehensiveTestRunner()
    
    try:
        success = runner.run_all_tests()
        return 0 if success else 1
        
    except KeyboardInterrupt:
        print("/nâš ï¸ í…ŒìŠ¤íŠ¸ê°€ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return 1
        
    except Exception as e:
        print(f"âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: {e}")
# BROKEN_REF:         import traceback
        traceback.print_exc()
        return 1


if __name__ == '__main__':
    sys.exit(main())