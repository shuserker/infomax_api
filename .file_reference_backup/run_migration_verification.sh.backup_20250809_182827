#!/bin/bash
# POSCO WatchHamster v3.0.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# Migration Verification Execution Script for POSCO WatchHamster v2.0

set -e  # ì˜¤ë¥˜ ì‹œ ì¤‘ë‹¨

echo "ğŸš€ POSCO WatchHamster v3.0.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹œìŠ¤í…œ ì‹¤í–‰"
echo "=================================================================="

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}[ë‹¨ê³„ $1]${NC} $2"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸ $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸ $1${NC}"
}

# ì‚¬ìš©ë²• ì¶œë ¥
show_usage() {
    echo "ì‚¬ìš©ë²•: $0 [ì˜µì…˜]"
    echo ""
    echo "ì˜µì…˜:"
    echo "  --full              ì „ì²´ ê²€ì¦ ì‹¤í–‰ (ê¸°ë³¸ê°’)"
    echo "  --backup-only       ë°±ì—… ê²€ì¦ë§Œ ì‹¤í–‰"
    echo "  --rollback-only     ë¡¤ë°± í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰"
    echo "  --post-only         ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦ë§Œ ì‹¤í–‰"
    echo "  --report-only       ë³´ê³ ì„œ ìƒì„±ë§Œ ì‹¤í–‰"
    echo "  --test-system       ê²€ì¦ ì‹œìŠ¤í…œ ìì²´ í…ŒìŠ¤íŠ¸"
    echo "  --cleanup           ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬"
    echo "  --help              ì´ ë„ì›€ë§ í‘œì‹œ"
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  $0                  # ì „ì²´ ê²€ì¦ ì‹¤í–‰"
    echo "  $0 --backup-only    # ë°±ì—… ê²€ì¦ë§Œ ì‹¤í–‰"
    echo "  $0 --test-system    # ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸"
}

# í™˜ê²½ í™•ì¸
check_environment() {
    print_step "0" "í™˜ê²½ í™•ì¸"
    
    # Python í™•ì¸
    if ! command -v python3 &> /dev/null; then
        print_error "Python3ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        exit 1
    fi
    
    PYTHON_VERSION=$(python3 --version 2>&1 | cut -d' ' -f2)
    print_success "Python ë²„ì „: $PYTHON_VERSION"
    
    # í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
    REQUIRED_SCRIPTS=(
        "migration_verification_system.py"
        "test_rollback_functionality.py"
        "post_migration_verification.py"
        "migration_status_reporter.py"
    )
    
    for script in "${REQUIRED_SCRIPTS[@]}"; do
        if [ -f "$script" ]; then
            print_success "$script ì¡´ì¬ í™•ì¸"
        else
            print_error "$script íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
        fi
    done
    
    # ì‹¤í–‰ ê¶Œí•œ í™•ì¸
    if [ ! -w "." ]; then
        print_error "í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"
        exit 1
    fi
    
    print_success "í™˜ê²½ í™•ì¸ ì™„ë£Œ"
}

# ë°±ì—… ê²€ì¦ ì‹¤í–‰
run_backup_verification() {
    print_step "1" "ë°±ì—… ì•ˆì „ì„± ê²€ì¦"
    
    if python3 migration_verification_system.py backup-check; then
        print_success "ë°±ì—… ê²€ì¦ ì™„ë£Œ"
        return 0
    else
        print_error "ë°±ì—… ê²€ì¦ ì‹¤íŒ¨"
        return 1
    fi
}

# ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
run_rollback_test() {
    print_step "2" "ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
    
    # ë¡¤ë°± í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    if python3 test_rollback_functionality.py; then
        print_success "ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        return 0
    else
        print_error "ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        return 1
    fi
}

# ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦
run_post_migration_verification() {
    print_step "3" "ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦"
    
    if python3 post_migration_verification.py; then
        print_success "ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦ ì™„ë£Œ"
        return 0
    else
        print_error "ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦ ì‹¤íŒ¨"
        return 1
    fi
}

# ì¢…í•© ë³´ê³ ì„œ ìƒì„±
generate_comprehensive_report() {
    print_step "4" "ì¢…í•© ë³´ê³ ì„œ ìƒì„±"
    
    # ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ ì‹œìŠ¤í…œ ë³´ê³ ì„œ
    if python3 migration_verification_system.py report; then
        print_success "ê²€ì¦ ì‹œìŠ¤í…œ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
    else
        print_warning "ê²€ì¦ ì‹œìŠ¤í…œ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨"
    fi
    
    # ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œ ë³´ê³ ì„œ
    if python3 migration_status_reporter.py report; then
        print_success "ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
    else
        print_warning "ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨"
    fi
    
    # í†µí•© ë³´ê³ ì„œ ìƒì„±
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    INTEGRATED_REPORT="integrated_migration_verification_report_${TIMESTAMP}.txt"
    
    {
        echo "=================================================================="
        echo "POSCO WatchHamster v3.0.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ í†µí•© ë³´ê³ ì„œ"
        echo "=================================================================="
        echo "ìƒì„± ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸: $0 $*"
        echo ""
        
        echo "ğŸ“‹ ì‹¤í–‰ëœ ê²€ì¦ í•­ëª©"
        echo "------------------------------------------------------------------"
        if [ "$BACKUP_RESULT" = "0" ]; then
            echo "âœ… ë°±ì—… ì•ˆì „ì„± ê²€ì¦: í†µê³¼"
        else
            echo "âŒ ë°±ì—… ì•ˆì „ì„± ê²€ì¦: ì‹¤íŒ¨"
        fi
        
        if [ "$ROLLBACK_RESULT" = "0" ]; then
            echo "âœ… ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸: í†µê³¼"
        else
            echo "âŒ ë¡¤ë°± ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
        fi
        
        if [ "$POST_MIGRATION_RESULT" = "0" ]; then
            echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦: í†µê³¼"
        else
            echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦: ì‹¤íŒ¨"
        fi
        
        echo ""
        echo "ğŸ“Š ì „ì²´ ê²°ê³¼ ìš”ì•½"
        echo "------------------------------------------------------------------"
        
        TOTAL_TESTS=3
        PASSED_TESTS=0
        
        [ "$BACKUP_RESULT" = "0" ] && PASSED_TESTS=$((PASSED_TESTS + 1))
        [ "$ROLLBACK_RESULT" = "0" ] && PASSED_TESTS=$((PASSED_TESTS + 1))
        [ "$POST_MIGRATION_RESULT" = "0" ] && PASSED_TESTS=$((PASSED_TESTS + 1))
        
        echo "ì „ì²´ í…ŒìŠ¤íŠ¸: ${TOTAL_TESTS}ê°œ"
        echo "í†µê³¼: ${PASSED_TESTS}ê°œ"
        echo "ì‹¤íŒ¨: $((TOTAL_TESTS - PASSED_TESTS))ê°œ"
        
        if [ $PASSED_TESTS -eq $TOTAL_TESTS ]; then
            echo ""
            echo "ğŸ‰ ê²°ë¡ : ëª¨ë“  ê²€ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "   ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì•ˆì „í•˜ê²Œ ì™„ë£Œë˜ì—ˆìœ¼ë©° ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤."
        else
            echo ""
            echo "âŒ ê²°ë¡ : ì¼ë¶€ ê²€ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "   ì‹¤íŒ¨í•œ í•­ëª©ì„ ê²€í† í•˜ê³  í•„ìš”ì‹œ ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”."
            echo "   ë¡¤ë°± ëª…ë ¹ì–´: ./rollback_migration.sh"
        fi
        
        echo ""
        echo "ğŸ“ ì§€ì› ì •ë³´"
        echo "------------------------------------------------------------------"
        echo "- ìƒì„¸ ë¡œê·¸: migration_logs/ ë””ë ‰í† ë¦¬"
        echo "- ê°œë³„ ë³´ê³ ì„œ: migration_reports/ ë””ë ‰í† ë¦¬"
        echo "- ê²€ì¦ ì¬ì‹¤í–‰: $0"
        echo "- ë¡¤ë°± ì‹¤í–‰: ./rollback_migration.sh"
        
        echo ""
        echo "=================================================================="
        
    } > "$INTEGRATED_REPORT"
    
    print_success "í†µí•© ë³´ê³ ì„œ ìƒì„±: $INTEGRATED_REPORT"
}

# ê²€ì¦ ì‹œìŠ¤í…œ ìì²´ í…ŒìŠ¤íŠ¸
run_system_test() {
    print_step "TEST" "ê²€ì¦ ì‹œìŠ¤í…œ ìì²´ í…ŒìŠ¤íŠ¸"
    
    if python3 test_migration_verification_system.py; then
        print_success "ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        return 0
    else
        print_error "ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        return 1
    fi
}

# ë¡œê·¸ ì •ë¦¬
cleanup_logs() {
    print_step "CLEANUP" "ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬"
    
    DAYS=${1:-30}
    
    # ìƒíƒœ ë³´ê³  ì‹œìŠ¤í…œì„ í†µí•œ ì •ë¦¬
    if python3 migration_status_reporter.py cleanup "$DAYS"; then
        print_success "ë¡œê·¸ ì •ë¦¬ ì™„ë£Œ (${DAYS}ì¼ ì´ì „)"
    else
        print_warning "ë¡œê·¸ ì •ë¦¬ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ ë°œìƒ"
    fi
    
    # ì¶”ê°€ ì •ë¦¬ ì‘ì—…
    find . -name "*.log" -type f -mtime +$DAYS -delete 2>/dev/null || true
    find . -name "*_report_*.txt" -type f -mtime +$DAYS -delete 2>/dev/null || true
    
    print_success "ì¶”ê°€ ë¡œê·¸ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
}

# ì „ì²´ ê²€ì¦ ì‹¤í–‰
run_full_verification() {
    print_info "ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
    echo ""
    
    # ìƒíƒœ ë³´ê³  ì‹œì‘
    python3 -c "
from migration_status_reporter import MigrationStatusReporter
reporter = MigrationStatusReporter()
reporter.start_migration_phase('full_verification', 'ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦')
" 2>/dev/null || true
    
    OVERALL_SUCCESS=true
    
    # 1. ë°±ì—… ê²€ì¦
    if run_backup_verification; then
        BACKUP_RESULT=0
    else
        BACKUP_RESULT=1
        OVERALL_SUCCESS=false
    fi
    
    echo ""
    
    # 2. ë¡¤ë°± í…ŒìŠ¤íŠ¸
    if run_rollback_test; then
        ROLLBACK_RESULT=0
    else
        ROLLBACK_RESULT=1
        OVERALL_SUCCESS=false
    fi
    
    echo ""
    
    # 3. ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ê²€ì¦
    if run_post_migration_verification; then
        POST_MIGRATION_RESULT=0
    else
        POST_MIGRATION_RESULT=1
        OVERALL_SUCCESS=false
    fi
    
    echo ""
    
    # 4. ë³´ê³ ì„œ ìƒì„±
    generate_comprehensive_report
    
    # ìƒíƒœ ë³´ê³  ì™„ë£Œ
    python3 -c "
from migration_status_reporter import MigrationStatusReporter
reporter = MigrationStatusReporter()
reporter.complete_migration_phase('full_verification', 'ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦', 0, $OVERALL_SUCCESS)
reporter.finalize_session('full_verification_completed')
" 2>/dev/null || true
    
    echo ""
    echo "=================================================================="
    
    if [ "$OVERALL_SUCCESS" = true ]; then
        print_success "ğŸ‰ ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo ""
        print_info "ë‹¤ìŒ ë‹¨ê³„:"
        echo "  1. ìƒì„±ëœ ë³´ê³ ì„œë¥¼ ê²€í† í•˜ì„¸ìš”"
        echo "  2. ì›Œì¹˜í–„ìŠ¤í„° ì‹œìŠ¤í…œì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        echo "  3. ì •ê¸°ì ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”"
        return 0
    else
        print_error "âŒ ì¼ë¶€ ê²€ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
        echo ""
        print_info "ê¶Œì¥ ì¡°ì¹˜:"
        echo "  1. ì‹¤íŒ¨í•œ í•­ëª©ì˜ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
        echo "  2. ë¬¸ì œë¥¼ í•´ê²°í•˜ê±°ë‚˜ ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”"
        echo "  3. ë¡¤ë°± ëª…ë ¹ì–´: ./rollback_migration.sh"
        return 1
    fi
}

# ë©”ì¸ ì‹¤í–‰ ë¡œì§
main() {
    # í™˜ê²½ í™•ì¸
    check_environment
    echo ""
    
    # ì˜µì…˜ ì²˜ë¦¬
    case "${1:-}" in
        --help|-h)
            show_usage
            exit 0
            ;;
        --backup-only)
            run_backup_verification
            exit $?
            ;;
        --rollback-only)
            run_rollback_test
            exit $?
            ;;
        --post-only)
            run_post_migration_verification
            exit $?
            ;;
        --report-only)
            generate_comprehensive_report
            exit 0
            ;;
        --test-system)
            run_system_test
            exit $?
            ;;
        --cleanup)
            cleanup_logs "${2:-30}"
            exit 0
            ;;
        --full|"")
            run_full_verification
            exit $?
            ;;
        *)
            print_error "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"